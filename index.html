<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TikTok Performance Panel</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,700,0,0" rel="stylesheet" />

  <style>
    :root{
      --bg0:#070812; --bg1:#0b1022;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --border:rgba(255,255,255,.16);
      --radius:18px;
      --shadow:0 14px 44px rgba(0,0,0,.55);
      --blur:14px;
      --max:1100px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 680px at 10% 0%, rgba(57,217,255,.22), transparent 58%),
        radial-gradient(900px 600px at 90% 0%, rgba(168,85,255,.18), transparent 60%),
        radial-gradient(900px 700px at 40% 105%, rgba(255,59,212,.16), transparent 60%),
        radial-gradient(700px 500px at 80% 90%, rgba(25,243,168,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .wrap{max-width:var(--max);margin:0 auto;padding:28px 18px 46px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.26), transparent 42%),
        linear-gradient(135deg, rgba(57,217,255,.95), rgba(168,85,255,.85));
      box-shadow:0 18px 48px rgba(0,0,0,.60);
      display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,.20);
      position:relative;overflow:hidden;
    }
    .logo:after{
      content:"";position:absolute;inset:-55%;
      background:
        radial-gradient(circle at 25% 25%, rgba(255,59,212,.28), transparent 42%),
        radial-gradient(circle at 70% 70%, rgba(25,243,168,.18), transparent 46%);
      transform:rotate(18deg);filter:blur(1px);opacity:.9;
    }
    .logo .material-symbols-rounded{font-size:22px;color:rgba(0,0,0,.92);z-index:1}
    .titleblock{min-width:0}
    h1{font-size:18px;margin:0 0 2px;letter-spacing:-.02em;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .subtitle{font-size:12.5px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      backdrop-filter:blur(var(--blur));
    }
    .pill .material-symbols-rounded{font-size:16px;color:rgba(255,255,255,.70)}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    button{
      cursor:pointer;border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);color:var(--text);
      padding:10px 12px;border-radius:14px;font-weight:800;letter-spacing:-.01em;
      display:inline-flex;align-items:center;gap:8px;
      transition:transform .08s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
      backdrop-filter:blur(var(--blur));
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    button:hover{background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.22);box-shadow:0 14px 40px rgba(0,0,0,.45)}
    button:active{transform:translateY(1px)}
    .primary{
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 45%),
        linear-gradient(135deg, rgba(57,217,255,.95), rgba(255,59,212,.75));
      border-color:rgba(255,255,255,.22);
      color:rgba(0,0,0,.92);
    }
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;margin-top:14px}
    .card{
      grid-column:span 12;
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.16);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(var(--blur));
      position:relative;overflow:hidden;
    }
    .card:before{
      content:"";position:absolute;inset:-1px;
      background:
        radial-gradient(circle at 12% 20%, rgba(57,217,255,.12), transparent 26%),
        radial-gradient(circle at 85% 30%, rgba(168,85,255,.10), transparent 30%),
        radial-gradient(circle at 70% 85%, rgba(255,59,212,.10), transparent 30%),
        radial-gradient(circle at 30% 85%, rgba(25,243,168,.08), transparent 30%),
        radial-gradient(circle at 10% 70%, rgba(255,210,74,.07), transparent 28%);
      pointer-events:none;
    }
    .cardhead{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:12px;position:relative;z-index:1}
    .cardhead h2{font-size:13px;margin:0;color:rgba(255,255,255,.90);font-weight:900;letter-spacing:.09em;text-transform:uppercase}
    .hint{color:var(--muted2);font-size:12px;margin-top:2px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;font-size:12px;color:rgba(255,255,255,.74)}
    .kpis{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;position:relative;z-index:1}
    .kpi{
      grid-column:span 12;padding:14px;border-radius:16px;
      border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.18);
      display:flex;gap:12px;align-items:center;
    }
    .kpi .ic{
      width:40px;height:40px;border-radius:14px;display:flex;align-items:center;justify-content:center;
      background:rgba(57,217,255,.16);border:1px solid rgba(57,217,255,.26);
      box-shadow:0 12px 32px rgba(0,0,0,.35);
    }
    .kpi .ic.purple{background:rgba(168,85,255,.16);border-color:rgba(168,85,255,.26)}
    .kpi .ic.pink{background:rgba(255,59,212,.14);border-color:rgba(255,59,212,.24)}
    .kpi .ic .material-symbols-rounded{color:rgba(255,255,255,.92)}
    .kpi .label{color:var(--muted);font-size:12.5px;font-weight:800}
    .kpi .val{font-size:20px;font-weight:950;letter-spacing:-.03em;margin-top:2px}
    .col6{grid-column:span 12}
    @media (min-width:860px){.kpi{grid-column:span 4}.col6{grid-column:span 6}}
    .list{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:10px;position:relative;z-index:1}
    .item{
      padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.18);display:flex;gap:10px;align-items:flex-start;
    }
    .badge{
      min-width:28px;height:28px;border-radius:10px;display:flex;align-items:center;justify-content:center;
      font-weight:950;color:rgba(0,0,0,.92);
      background:linear-gradient(135deg, rgba(57,217,255,.98), rgba(255,59,212,.78));
      border:1px solid rgba(255,255,255,.22);font-size:12px;
      box-shadow:0 12px 28px rgba(0,0,0,.30);flex:0 0 auto;
    }
    .thumb{
      width:96px;height:136px;border-radius:16px;overflow:hidden;
      border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.22);
      flex:0 0 auto;box-shadow:0 12px 28px rgba(0,0,0,.30);
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .text{font-size:13.5px;color:rgba(255,255,255,.90);line-height:1.35;overflow-wrap:anywhere;word-break:break-word;flex:1 1 auto;min-width:0}
    .rows{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .row{display:flex;gap:10px;flex-wrap:wrap;color:rgba(255,255,255,.82);font-size:12.5px}
    .kv{
      display:inline-flex;gap:6px;align-items:center;padding:7px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);
    }
    .kv b{color:rgba(255,255,255,.92);font-weight:950}
    .kv span{color:rgba(255,255,255,.72);font-weight:800;display:inline-flex;align-items:center;gap:6px}
    .kv .material-symbols-rounded{font-size:16px;opacity:.95}
    .btnLink{
      display:inline-flex;align-items:center;gap:8px;margin-top:10px;padding:9px 12px;border-radius:12px;
      text-decoration:none;font-weight:950;letter-spacing:-.01em;color:rgba(0,0,0,.92);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 46%),
        linear-gradient(135deg, rgba(57,217,255,.96), rgba(168,85,255,.86));
      border:1px solid rgba(255,255,255,.20);
      box-shadow:0 14px 36px rgba(0,0,0,.45);
      transition:transform .08s ease, filter .2s ease, box-shadow .2s ease;
      width:fit-content;
    }
    .btnLink:hover{filter:brightness(1.04);box-shadow:0 18px 44px rgba(0,0,0,.55)}
    .btnLink:active{transform:translateY(1px)}
    .btnLink .material-symbols-rounded{font-size:18px}
    .empty{
      border:1px dashed rgba(255,255,255,.20);background:rgba(0,0,0,.16);
      padding:14px;border-radius:16px;color:var(--muted);line-height:1.35;font-size:13px;position:relative;z-index:1;
    }
    .footer{
      margin-top:16px;color:rgba(255,255,255,.55);font-size:12px;
      display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"><span class="material-symbols-rounded">sensors</span></div>
        <div class="titleblock">
          <h1>TikTok Performance Panel</h1>
          <div class="subtitle">
            <span class="pill"><span class="material-symbols-rounded">folder</span><span id="src">reports/—.json</span></span>
            <span class="pill"><span class="material-symbols-rounded">event</span><span id="dateLabel">—</span></span>
            <span class="pill"><span class="material-symbols-rounded">tune</span><span id="minViewsLabel">—</span></span>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="btnPrev"><span class="material-symbols-rounded">chevron_left</span>día anterior</button>
        <button id="btnNext"><span class="material-symbols-rounded">chevron_right</span>día siguiente</button>
        <button class="primary" id="btnToday"><span class="material-symbols-rounded">today</span>hoy</button>
        <button id="btnReload"><span class="material-symbols-rounded">refresh</span>recargar</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardhead">
          <div>
            <h2>Resumen</h2>
            <div class="hint">Rankings calculados localmente desde el bundle.</div>
          </div>
          <div class="mono" id="statusLine">—</div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="ic"><span class="material-symbols-rounded">video_library</span></div>
            <div>
              <div class="label">Items válidos</div>
              <div class="val" id="kpiItems">—</div>
            </div>
          </div>

          <div class="kpi">
            <div class="ic purple"><span class="material-symbols-rounded">favorite</span></div>
            <div>
              <div class="label">Top likes (max 10)</div>
              <div class="val" id="kpiTopLikes">—</div>
            </div>
          </div>

          <div class="kpi">
            <div class="ic pink"><span class="material-symbols-rounded">percent</span></div>
            <div>
              <div class="label">Top like rate filtrado</div>
              <div class="val" id="kpiTopRate">—</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card col6">
        <div class="cardhead">
          <div>
            <h2>Top videos por likes</h2>
            <div class="hint">Orden: likes desc, views desc, video_id asc.</div>
          </div>
        </div>
        <ul class="list" id="listTopLikes"></ul>
        <div id="emptyTopLikes" class="empty" style="display:none;">No hay items válidos.</div>
      </div>

      <div class="card col6">
        <div class="cardhead">
          <div>
            <h2>Top videos por like rate</h2>
            <div class="hint">Filtrado por views >= umbral.</div>
          </div>
        </div>
        <ul class="list" id="listTopRate"></ul>
        <div id="emptyTopRate" class="empty" style="display:none;">No hay items que pasen el umbral.</div>
      </div>

      <div class="card">
        <div class="cardhead">
          <div>
            <h2>Ranking de creadores</h2>
            <div class="hint">Orden: top_count_likes desc, sum_likes desc, avg_like_rate desc.</div>
          </div>
        </div>
        <ul class="list" id="listCreators"></ul>
        <div id="emptyCreators" class="empty" style="display:none;">No hay creadores.</div>
      </div>
    </div>

    <div class="footer">
      <div>tiktok performance tracker — todo local</div>
      <div><span class="mono" id="errorsLine">—</span></div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const MIN_VIEWS_FOR_RATE_DEFAULT = 10000;
    const MAX_TOP = 10;

    // ====== NAV (copiada de tu lógica Pornhub) ======
    const REPORTS_DIR = "reports";
    const MAX_FALLBACK_DAYS = 14;

    // Si quieres inyectar directo (opcional), pon aquí el objeto {text:"..."}
    const BUNDLE_PAYLOAD = null;

    // =========================
    // Helpers
    // =========================
    const pad2 = (n) => String(n).padStart(2, "0");
    const toYMD = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const addDays = (d, days) => { const x = new Date(d); x.setDate(x.getDate() + days); return x; };

    function setText(id, val){ document.getElementById(id).textContent = (val ?? "—"); }
    function show(el, yes){ el.style.display = yes ? "" : "none"; }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function fmtInt(n){
      const x = Number(n);
      if(!Number.isFinite(x)) return "0";
      return x.toLocaleString("es-CO");
    }

    function fmtPctNoDecimals(n){
      const x = Number(n);
      if(!Number.isFinite(x)) return "0%";
      return `${Math.round(x)}%`;
    }

    function safeNum(x){
      const s = String(x ?? "").trim();
      if(!s) return 0;
      const n = Number(s.replace(/[^\d.-]/g, ""));
      return Number.isFinite(n) ? n : 0;
    }

    function getVideoIdFromUrl(url){
      const s = String(url || "");
      const m = s.match(/\/video\/(\d+)/);
      return m ? m[1] : "";
    }

    // =========================
    // Parse the "text" field: it contains many <li> blocks
    // =========================
    function parseItemsFromText(htmlText, errors){
      const out = [];
      const tmp = document.createElement("div");
      tmp.innerHTML = String(htmlText || "");

      const lis = Array.from(tmp.querySelectorAll("li"));
      for (let i=0; i<lis.length; i++){
        const li = lis[i];

        const anchors = Array.from(li.querySelectorAll("a"));
        const urlA = anchors.find(a => {
          const h = (a.getAttribute("href") || "").trim();
          return /tiktok\.com/i.test(h) && /\/video\/\d+/.test(h);
        });
        const url = (urlA ? (urlA.getAttribute("href") || "") : "").trim();

        const coverA = anchors.find(a => /tiktokcdn/i.test((a.getAttribute("href") || "").trim()));
        const cover_url = (coverA ? (coverA.getAttribute("href") || "") : "").trim();

        const strongs = Array.from(li.querySelectorAll("strong")).map(s => (s.textContent || "").trim());
        const username = (strongs[0] || "").replace(/^@/,"").trim();
        const views = safeNum(strongs[1]);
        const likes = safeNum(strongs[2]);

        const video_id = getVideoIdFromUrl(url);

        const isEmpty = !url && !cover_url && !username && views===0 && likes===0;
        if(isEmpty) continue;

        if((url && !video_id) || (!url && (likes>0 || views>0))){
          errors.push(`item_${i+1}_missing_or_bad_url_or_id`);
        }

        out.push({ url, cover_url, username, video_id, views, likes });
      }
      return out;
    }

    // =========================
    // Dedupe by video_id
    // =========================
    function dedupeByVideoId(items){
      const map = new Map();
      for(const it of items){
        const key = it.video_id || "";
        if(!key){
          map.set(`__noid__${Math.random().toString(16).slice(2)}`, it);
          continue;
        }
        if(!map.has(key)){
          map.set(keykey = key, it);
        } else {
          const cur = map.get(key);
          if((it.views > cur.views) || (it.views === cur.views && it.likes > cur.likes)){
            map.set(key, it);
          }
        }
      }
      return Array.from(map.values());
    }

    function computeLikeRate(it){
      const v = safeNum(it.views);
      const l = safeNum(it.likes);
      const like_rate = v > 0 ? (l / v) : 0;
      const like_rate_pct = Math.round(like_rate * 100000) / 1000; // 3 decimals
      return { like_rate, like_rate_pct };
    }

    function sortTopLikes(items){
      return [...items].sort((a,b)=>{
        const la = safeNum(a.likes), lb = safeNum(b.likes);
        if(lb !== la) return lb - la;
        const va = safeNum(a.views), vb = safeNum(b.views);
        if(vb !== va) return vb - va;
        return String(a.video_id||"").localeCompare(String(b.video_id||""));
      });
    }

    function sortTopRate(items){
      return [...items].sort((a,b)=>{
        const ra = Number(a.like_rate)||0;
        const rb = Number(b.like_rate)||0;
        if(rb !== ra) return rb - ra;
        const va = safeNum(a.views), vb = safeNum(b.views);
        if(vb !== va) return vb - va;
        const la = safeNum(a.likes), lb = safeNum(b.likes);
        if(lb !== la) return lb - la;
        return String(a.video_id||"").localeCompare(String(b.video_id||""));
      });
    }

    function aggregateCreators(items, topLikesList){
      const topLikesSet = new Set(topLikesList.map(v => v.url).filter(Boolean));
      const topLikesOrder = topLikesList.map(v => v.url).filter(Boolean);

      const map = new Map();
      for(const it of items){
        const u = String(it.username||"").trim();
        if(!u) continue;

        if(!map.has(u)){
          map.set(u, {
            username: u,
            videos_total_en_dataset: 0,
            sum_views: 0,
            sum_likes: 0,
            sum_like_rate: 0,
            top_count_likes: 0
          });
        }
        const c = map.get(u);
        c.videos_total_en_dataset += 1;
        c.sum_views += safeNum(it.views);
        c.sum_likes += safeNum(it.likes);
        c.sum_like_rate += Number(it.like_rate)||0;
        if(topLikesSet.has(it.url)) c.top_count_likes += 1;
      }

      const arr = Array.from(map.values()).map(c => {
        const avg = c.videos_total_en_dataset ? (c.sum_like_rate / c.videos_total_en_dataset) : 0;
        return {
          ...c,
          avg_like_rate: avg,
          avg_like_rate_pct: Math.round(avg * 100000) / 1000,
          top_video_urls_likes: topLikesOrder.filter(url => items.some(v => v.username === c.username && v.url === url))
        };
      }).sort((a,b)=>{
        if(b.top_count_likes !== a.top_count_likes) return b.top_count_likes - a.top_count_likes;
        if(b.sum_likes !== a.sum_likes) return b.sum_likes - a.sum_likes;
        if(b.avg_like_rate !== a.avg_like_rate) return b.avg_like_rate - a.avg_like_rate;
        return a.username.localeCompare(b.username);
      });

      return arr.slice(0, 10).map((c,i)=>({ ...c, rank:i+1 }));
    }

    // =========================
    // Rendering
    // =========================
    function makeVideoItem(v, idx){
      const rank = idx + 1;
      const url = v.url || "";
      const user = v.username || "";
      const views = v.views ?? 0;
      const likes = v.likes ?? 0;
      const lrPct = v.like_rate_pct ?? 0;
      const cover = v.cover_url || "";

      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = `
        <div class="badge">${escapeHtml(String(rank))}</div>
        ${cover ? `<div class="thumb"><img src="${escapeHtml(cover)}" alt="cover" referrerpolicy="no-referrer"></div>` : ``}
        <div class="text">
          <div style="font-weight:950; letter-spacing:-0.01em;">@${escapeHtml(user || "—")} — ${escapeHtml(fmtInt(likes))} likes</div>
          <div class="rows">
            <div class="row">
              <span class="kv"><span><span class="material-symbols-rounded">play_circle</span>views</span> <b>${escapeHtml(fmtInt(views))}</b></span>
              <span class="kv"><span><span class="material-symbols-rounded">favorite</span>likes</span> <b>${escapeHtml(fmtInt(likes))}</b></span>
              <span class="kv"><span><span class="material-symbols-rounded">percent</span>like rate</span> <b>${escapeHtml(fmtPctNoDecimals(lrPct))}</b></span>
            </div>
          </div>
          ${url ? `<a class="btnLink" href="${escapeHtml(url)}" target="_blank" rel="noopener">
            <span class="material-symbols-rounded">smart_display</span>abrir en tiktok
          </a>` : ``}
        </div>
      `;
      return li;
    }

    function makeCreatorItem(c){
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = `
        <div class="badge">${escapeHtml(String(c.rank || 0))}</div>
        <div class="text">
          <div style="font-weight:950; letter-spacing:-0.01em;">@${escapeHtml(c.username || "—")}</div>
          <div class="rows">
            <div class="row">
              <span class="kv"><span><span class="material-symbols-rounded">video_library</span>videos</span> <b>${escapeHtml(String(c.videos_total_en_dataset ?? 0))}</b></span>
              <span class="kv"><span><span class="material-symbols-rounded">emoji_events</span>top</span> <b>${escapeHtml(String(c.top_count_likes ?? 0))}</b></span>
              <span class="kv"><span><span class="material-symbols-rounded">favorite</span>sum likes</span> <b>${escapeHtml(fmtInt(c.sum_likes ?? 0))}</b></span>
              <span class="kv"><span><span class="material-symbols-rounded">play_circle</span>sum views</span> <b>${escapeHtml(fmtInt(c.sum_views ?? 0))}</b></span>
              <span class="kv"><span><span class="material-symbols-rounded">percent</span>avg rate</span> <b>${escapeHtml(fmtPctNoDecimals(c.avg_like_rate_pct ?? 0))}</b></span>
            </div>
          </div>
          ${Array.isArray(c.top_video_urls_likes) && c.top_video_urls_likes.length ? `
            <div class="rows">
              <div class="row">
                <span class="kv"><span><span class="material-symbols-rounded">link</span>top urls</span> <b>${escapeHtml(String(c.top_video_urls_likes.length))}</b></span>
              </div>
            </div>
          ` : ``}
        </div>
      `;
      return li;
    }

    function renderList(listId, emptyId, arr, itemFactory){
      const ul = document.getElementById(listId);
      ul.innerHTML = "";
      if(Array.isArray(arr) && arr.length){
        arr.forEach((x, i)=> ul.appendChild(itemFactory(x, i)));
        show(document.getElementById(emptyId), false);
      }else{
        show(document.getElementById(emptyId), true);
      }
    }

    // =========================
    // Load JSON from reports/AAAA-MM-DD.json
    // Supports:
    // 1) {text:"..."}
    // 2) [{json:"{...}"}]
    // =========================
    function unwrapMake(payload){
      if (Array.isArray(payload) && payload.length && payload[0] && typeof payload[0] === "object") {
        if (typeof payload[0].json === "string") {
          try { return JSON.parse(payload[0].json); } catch(e) { return null; }
        }
      }
      return payload;
    }

    function fileUrl(ymd){ return `${REPORTS_DIR}/${ymd}.json`; }

    async function fetchJson(url){
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return await res.json();
    }

    // ====== NAV state ======
    let selectedDate = new Date();

    async function loadDate(d){
      const errors = [];
      const ymd = toYMD(d);
      const url = fileUrl(ymd);

      setText("src", url);
      setText("dateLabel", ymd);
      setText("minViewsLabel", `umbral: ${fmtInt(MIN_VIEWS_FOR_RATE_DEFAULT)} views`);
      setText("statusLine", `cargando: ${ymd}...`);

      try{
        const raw = BUNDLE_PAYLOAD ? BUNDLE_PAYLOAD : await fetchJson(url);
        const obj = unwrapMake(raw);
        if(!obj || typeof obj !== "object") throw new Error("payload inválido (json)");
        const htmlText = String(obj.text || "");
        if(!htmlText) throw new Error("falta obj.text con los <li>");

        let items = parseItemsFromText(htmlText, errors);

        items = items.map(it => {
          const { like_rate, like_rate_pct } = computeLikeRate(it);
          return { ...it, like_rate, like_rate_pct };
        });

        const before = items.length;
        items = dedupeByVideoId(items);
        const after = items.length;

        const topLikes = sortTopLikes(items).slice(0, MAX_TOP);
        const filtered = items.filter(v => safeNum(v.views) >= MIN_VIEWS_FOR_RATE_DEFAULT);
        const topRateFiltered = sortTopRate(filtered).slice(0, MAX_TOP);
        const creators = aggregateCreators(items, topLikes);

        setText("kpiItems", String(after));
        setText("kpiTopLikes", String(topLikes.length));
        setText("kpiTopRate", String(topRateFiltered.length));
        setText("statusLine", `items: ${before} | dedup: ${after} | errors: ${errors.length}`);

        renderList("listTopLikes", "emptyTopLikes", topLikes, makeVideoItem);
        renderList("listTopRate", "emptyTopRate", topRateFiltered, makeVideoItem);
        renderList("listCreators", "emptyCreators", creators, (c)=>makeCreatorItem(c));

        setText("errorsLine", errors.length ? `errores: ${errors.slice(0,6).join(" | ")}${errors.length>6 ? " | ..." : ""}` : "sin errores");

        selectedDate = d;
        return true;
      } catch(e){
        // No tocamos el render general (lo deja en empty), solo reportamos fallo
        setText("statusLine", `no existe o falló: ${ymd} (${e.message || e})`);
        return false;
      }
    }

    async function loadWithFallback(startDate){
      for(let i=0; i<=MAX_FALLBACK_DAYS; i++){
        const d = addDays(startDate, -i);
        const ok = await loadDate(d);
        if(ok) return;
      }

      // fallback final: limpia como ya lo hacías cuando falla
      setText("statusLine", "sin datos (no se encontraron archivos recientes)");
      setText("errorsLine", "—");
      setText("kpiItems", "0"); setText("kpiTopLikes", "0"); setText("kpiTopRate", "0");
      document.getElementById("listTopLikes").innerHTML = "";
      document.getElementById("listTopRate").innerHTML = "";
      document.getElementById("listCreators").innerHTML = "";
      show(document.getElementById("emptyTopLikes"), true);
      show(document.getElementById("emptyTopRate"), true);
      show(document.getElementById("emptyCreators"), true);
    }

    // ====== NAV buttons ======
    document.getElementById("btnToday").addEventListener("click", () => loadWithFallback(new Date()));
    document.getElementById("btnReload").addEventListener("click", () => loadWithFallback(selectedDate));
    document.getElementById("btnPrev").addEventListener("click", () => loadWithFallback(addDays(selectedDate, -1)));
    document.getElementById("btnNext").addEventListener("click", () => loadWithFallback(addDays(selectedDate, +1)));

    // Start + auto refresh
    loadWithFallback(new Date());
    setInterval(() => loadWithFallback(selectedDate), 10 * 60 * 1000);
  </script>
</body>
</html>
