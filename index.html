<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trendfinder TikTok</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #070A12;
      --panel: rgba(255,255,255,0.06);
      --stroke: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);
      --muted2: rgba(255,255,255,0.44);

      --sky: #39D6FF;
      --purple: #A855F7;
      --pink: #FF3EA5;
      --lime: #9EFF7A;

      --shadow: 0 14px 50px rgba(0,0,0,0.55);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(57,214,255,0.14), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(168,85,247,0.16), transparent 62%),
        radial-gradient(900px 700px at 40% 115%, rgba(255,62,165,0.10), transparent 60%),
        linear-gradient(180deg, #050712 0%, #070A12 50%, #04050B 100%);
      color: var(--text);
      overflow-x:hidden;
    }

    .memphis{
      position:fixed; inset:0;
      pointer-events:none;
      opacity:0.55;
      z-index:0;
      filter: blur(0.2px);
    }
    .shape{
      position:absolute;
      border: 1px solid rgba(255,255,255,0.09);
      background: rgba(255,255,255,0.02);
      border-radius: 999px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.35);
    }
    .shape.s1{ width:220px; height:220px; left:-60px; top:110px; border-color: rgba(57,214,255,0.25); }
    .shape.s2{ width:180px; height:180px; right:-70px; top:180px; border-color: rgba(168,85,247,0.24); }
    .shape.s3{ width:120px; height:120px; left:18%; bottom:90px; border-color: rgba(255,62,165,0.22); border-radius: 22px; transform: rotate(14deg); }
    .shape.s4{ width:260px; height:120px; right:10%; bottom:40px; border-color: rgba(57,214,255,0.18); border-radius: 26px; transform: rotate(-10deg); }
    .dots{
      position:absolute; left:55%; top:38%;
      width:220px; height:120px;
      background-image: radial-gradient(rgba(255,255,255,0.12) 1.2px, transparent 1.2px);
      background-size: 14px 14px;
      opacity:0.35;
      border-radius: 20px;
      border: 1px dashed rgba(255,255,255,0.08);
      transform: rotate(6deg);
    }

    .container{
      position:relative;
      z-index:1;
      width: min(1180px, calc(100% - 36px));
      margin: 0 auto;
      padding: 22px 0 60px;
    }

    .topbar{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      padding: 18px 18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.04));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 240px;
    }
    .logo{
      width:40px;height:40px;border-radius: 12px;
      background:
        radial-gradient(14px 14px at 30% 30%, rgba(57,214,255,0.9), transparent 55%),
        radial-gradient(18px 18px at 70% 70%, rgba(168,85,247,0.85), transparent 55%),
        linear-gradient(135deg, rgba(255,62,165,0.18), rgba(57,214,255,0.14));
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 18px 60px rgba(0,0,0,0.45);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset: 9px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.02);
    }

    .brand h1{
      margin:0;
      font-size: 15px;
      letter-spacing: 0.2px;
      line-height:1.1;
      font-weight: 700;
    }
    .brand p{
      margin:3px 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    .controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      width: 100%;
    }

    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.03);
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }

    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(0,0,0,0.28);
      border: 1px solid var(--stroke);
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }
    .chip b{ color: var(--text); font-weight: 600; }

    .btn{
      height: 38px;
      padding: 0 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: transform .12s ease, border .15s ease, background .15s ease;
      display:flex; align-items:center; gap:8px;
      user-select:none;
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,0.20); background: rgba(255,255,255,0.06); }
    .btn:active{ transform: translateY(0px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(57,214,255,0.16), rgba(168,85,247,0.10));
      border-color: rgba(255,255,255,0.14);
    }

    .input, select{
      height: 38px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      padding: 0 12px;
      font-size: 13px;
      outline:none;
      transition: border .15s ease, background .15s ease;
      min-width: 200px;
    }
    .input:focus, select:focus{
      border-color: rgba(57,214,255,0.45);
      background: rgba(255,255,255,0.06);
    }

    .grid{
      margin-top: 16px;
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.035));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .cardHeader{
      padding: 14px 16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .cardTitle{
      margin:0;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.15px;
    }
    .cardSub{
      margin:6px 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
    .cardBody{ padding: 14px 16px; }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
    }
    .kpi{
      padding: 12px 12px;
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      min-height: 74px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .kpi .label{
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 0.25px;
    }
    .kpi .value{
      margin-top: 8px;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 0.2px;
    }
    .kpi .hint{
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted2);
      font-family: var(--mono);
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      display:flex;
      gap:12px;
      align-items:flex-start;
      padding: 12px 12px;
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
    }
    .badge{
      min-width: 34px; height: 34px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 800;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      flex: 0 0 auto;
    }
    .itemMain{ flex:1; min-width:0; }
    .itemTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap: wrap;
    }
    .itemTitle{
      font-size: 13px;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 820px;
    }
    .itemTitle a{
      color: var(--text);
      text-decoration: none;
    }
    .itemTitle a:hover{
      color: rgba(57,214,255,0.95);
      text-decoration: underline;
    }
    .itemMeta{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .metaTag{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(255,255,255,0.72);
      white-space: nowrap;
    }

    .notice{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
      white-space: pre-wrap;
    }

    @media (max-width: 980px){
      .kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .controls{ justify-content:flex-start; }
      .input, select{ min-width: 180px; flex: 1; }
    }
    @media (max-width: 540px){
      .topbar{ padding: 14px 14px; }
      .kpis{ grid-template-columns: 1fr; }
      .itemTitle{ max-width: 100%; }
    }
  </style>
</head>

<body>
  <div class="memphis" aria-hidden="true">
    <div class="shape s1"></div>
    <div class="shape s2"></div>
    <div class="shape s3"></div>
    <div class="shape s4"></div>
    <div class="dots"></div>
  </div>

  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Trendfinder TikTok</h1>
          <p id="subtitle">Renderiza /reports/YYYY-MM-DD.json (ej: 2026-01-16.json)</p>
        </div>
      </div>

      <div class="controls">
        <span class="pill" id="filePill">—</span>
        <span class="pill" id="datePill">día: —</span>
        <span class="pill" id="fetchPill">sync: —</span>

        <button class="btn" id="btnPrev" type="button">día anterior</button>
        <button class="btn" id="btnNext" type="button">día siguiente</button>
        <button class="btn primary" id="btnToday" type="button">hoy</button>
        <button class="btn" id="btnReload" type="button">recargar</button>

        <div class="chip">items: <b id="metaCount">0</b></div>
        <div class="chip">umbral: <b id="thr">—</b></div>

        <input id="q" class="input" placeholder="Buscar por @usuario o video_id…" />
        <select id="creatorFilter">
          <option value="">Todos los creadores</option>
        </select>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="cardTitle">Resumen (KPIs)</div>
            <div class="cardSub">Dataset del día (dedup) + métricas.</div>
          </div>
          <div class="pill" id="srcPill">fuente: —</div>
        </div>
        <div class="cardBody">
          <div class="kpis" id="kpis"></div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="cardTitle">Top videos</div>
            <div class="cardSub">Si el JSON trae top_videos se usa; si no, se deriva desde data.videos.</div>
          </div>
          <div class="pill" id="topHint">—</div>
        </div>
        <div class="cardBody">
          <div class="list" id="topList"></div>
          <div class="notice" id="topEmpty" style="display:none;">No hay videos para este día (o el archivo no existe).</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /*
      IMPORTANTE FELIPE:
      - Este dashboard carga UN archivo por día desde la carpeta /reports.
      - Formato exacto: reports/YYYY-MM-DD.json
        Ejemplo: reports/2026-01-16.json
      - Los botones prev/next/hoy cambian la fecha y por tanto el archivo a cargar.
    */

    const REPORTS_DIR = "reports";
    const MAX_FALLBACK_DAYS = 14;

    const pad2 = (n) => String(n).padStart(2, "0");
    const toYMD = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const addDays = (d, days) => { const x = new Date(d); x.setDate(x.getDate() + days); return x; };
    const fileUrl = (ymd) => `${REPORTS_DIR}/${ymd}.json`; // <-- 2026-01-16.json

    function formatNiceDate(ymd){
      const [Y,M,D] = ymd.split("-").map(Number);
      const d = new Date(Y, M-1, D);
      return d.toLocaleDateString("es-CO", { weekday:"long", year:"numeric", month:"long", day:"numeric" });
    }

    async function fetchJson(url){
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return await res.json();
    }

    function setText(id, val){ document.getElementById(id).textContent = (val ?? "—"); }
    function show(el, yes){ el.style.display = yes ? "" : "none"; }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function unwrapMakePayload(payload){
      // Soporta wrapper Make:
      // - [{ "json": "{...}" }]
      // - [{ "result": "{...}" }]
      // - { "result": "{...}" }
      if(Array.isArray(payload) && payload.length && payload[0] && typeof payload[0] === "object"){
        if(typeof payload[0].json === "string"){
          try { return JSON.parse(payload[0].json); } catch(e){ return null; }
        }
        if(typeof payload[0].result === "string"){
          try { return JSON.parse(payload[0].result); } catch(e){ return null; }
        }
      }
      if(payload && typeof payload === "object" && typeof payload.result === "string"){
        try { return JSON.parse(payload.result); } catch(e){ return null; }
      }
      return payload;
    }

    const safeNum = (n) => Number.isFinite(+n) ? +n : 0;

    function fmtK(n){
      n = safeNum(n);
      const abs = Math.abs(n);
      if (abs >= 1e9) return (n/1e9).toFixed(2).replace(/\.00$/,"") + "B";
      if (abs >= 1e6) return (n/1e6).toFixed(2).replace(/\.00$/,"") + "M";
      if (abs >= 1e3) return (n/1e3).toFixed(1).replace(/\.0$/,"") + "K";
      return String(Math.round(n));
    }

    function fmtPct(p){
      p = safeNum(p);
      return (Math.round(p*1000)/1000).toFixed(3).replace(/\.000$/,"") + "%";
    }

    function getThreshold(json){
      const p = json.parametros || {};
      const a = safeNum(p.umbral_views_like_rate);
      const b = safeNum(p.MIN_VIEWS_FOR_RATE);
      return a || b || 0;
    }

    function normalizeVideos(json){
      const raw = (json.data && Array.isArray(json.data.videos)) ? json.data.videos : [];
      const seen = new Set();
      const out = [];
      for (const v of raw){
        const url = (v.url || "").trim();
        const key = url || ((v.username||"") + "|" + (v.video_id||""));
        if(!key) continue;
        if(seen.has(key)) continue;
        seen.add(key);

        const views = safeNum(v.views);
        const likes = safeNum(v.likes);
        const like_rate = views > 0 ? (likes/views) : 0;

        out.push({
          rank_input: safeNum(v.rank_input),
          url,
          username: (v.username||"").trim(),
          video_id: (v.video_id||"").trim(),
          views,
          likes,
          like_rate,
          like_rate_pct: like_rate*100
        });
      }
      return out;
    }

    function sortByMany(arr, ...comparators){
      const a = arr.slice();
      a.sort((x,y)=>{
        for (const cmp of comparators){
          const r = cmp(x,y);
          if (r) return r;
        }
        return 0;
      });
      return a;
    }

    const UI_STATE = {
      videosAll: [],
      topAll: [],
      selectedCreator: "",
      query: ""
    };

    function kpiCard(label, value, hint){
      return `
        <div class="kpi">
          <div class="label">${escapeHtml(label)}</div>
          <div class="value">${escapeHtml(String(value))}</div>
          <div class="hint">${escapeHtml(String(hint || ""))}</div>
        </div>
      `;
    }

    function videoItem(i, t){
      if(typeof t === "string"){
        return `
          <div class="item">
            <div class="badge">${i+1}</div>
            <div class="itemMain">
              <div class="itemTop">
                <div class="itemTitle">${escapeHtml(t)}</div>
              </div>
            </div>
          </div>
        `;
      }

      const username = t.username || "—";
      const vid = t.video_id || "—";
      const title = `@${username} · ${vid}`;
      const url = t.url || "#";

      return `
        <div class="item">
          <div class="badge">${i+1}</div>
          <div class="itemMain">
            <div class="itemTop">
              <div class="itemTitle"><a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(title)}</a></div>
              <div class="pill" style="padding:6px 10px; font-family: var(--mono);">rate: ${escapeHtml(fmtPct(t.like_rate_pct))}</div>
            </div>
            <div class="itemMeta">
              <span class="metaTag">views ${escapeHtml(fmtK(t.views))}</span>
              <span class="metaTag">likes ${escapeHtml(fmtK(t.likes))}</span>
            </div>
          </div>
        </div>
      `;
    }

    function populateCreatorsDropdown(videos){
      const sel = document.getElementById("creatorFilter");
      const prev = UI_STATE.selectedCreator;

      const names = Array.from(new Set(
        (videos || []).map(v => (v.username || "").trim()).filter(Boolean)
      )).sort((a,b)=> a.localeCompare(b));

      sel.innerHTML = `<option value="">Todos los creadores</option>` +
        names.map(u => `<option value="${escapeHtml(u)}">@${escapeHtml(u)}</option>`).join("");

      sel.value = prev && names.includes(prev) ? prev : "";
      UI_STATE.selectedCreator = sel.value;
    }

    function applyTopFiltersAndRender(){
      const q = (UI_STATE.query || "").toLowerCase();
      const creator = (UI_STATE.selectedCreator || "").toLowerCase();

      let list = UI_STATE.topAll.slice();

      if(creator){
        list = list.filter(t => (typeof t === "string") ? true : ((t.username||"").toLowerCase() === creator));
      }
      if(q){
        list = list.filter(t => {
          const txt = (typeof t === "string")
            ? t
            : (`@${t.username||""} ${t.video_id||""} ${t.url||""} views ${t.views} likes ${t.likes}`);
          return txt.toLowerCase().includes(q);
        });
      }

      const topRoot = document.getElementById("topList");
      topRoot.innerHTML = "";
      if(list.length){
        topRoot.innerHTML = list.map((t,i)=> videoItem(i,t)).join("");
        show(document.getElementById("topEmpty"), false);
      } else {
        show(document.getElementById("topEmpty"), true);
      }

      setText("topHint", `top: ${list.length || 0}`);
    }

    function render(data, ymd, resolvedUrl){
      setText("filePill", resolvedUrl ?? "—");
      setText("datePill", "día: " + (ymd ? formatNiceDate(ymd) : "—"));
      setText("fetchPill", "sync: " + new Date().toLocaleString("es-CO"));

      const metaFuente = data?.meta?.fuente ?? "—";
      setText("srcPill", "fuente: " + metaFuente);

      const thr = getThreshold(data);
      setText("thr", String(thr || 0));

      const videos = normalizeVideos(data);
      UI_STATE.videosAll = videos;

      setText("metaCount", String(safeNum(data?.meta?.total_items) || videos.length));

      // Top: si existe top_videos, úsalo; si no, deriva de data.videos por likes
      const topRaw = (Array.isArray(data?.top_videos) ? data.top_videos : []);
      const topFromJson = topRaw.length ? topRaw : [];

      const topDerived = sortByMany(
        videos,
        (a,b)=> b.likes - a.likes,
        (a,b)=> b.views - a.views,
        (a,b)=> b.like_rate - a.like_rate
      ).slice(0, 10);

      UI_STATE.topAll = topFromJson.length ? topFromJson : topDerived;

      populateCreatorsDropdown(videos);

      const totalViews = videos.reduce((a,v)=> a+v.views, 0);
      const totalLikes = videos.reduce((a,v)=> a+v.likes, 0);
      const avgRate = videos.length ? videos.reduce((a,v)=> a+v.like_rate, 0) / videos.length : 0;

      document.getElementById("kpis").innerHTML = [
        kpiCard("Videos", videos.length, "dataset (dedup)"),
        kpiCard("Views", fmtK(totalViews), "suma"),
        kpiCard("Likes", fmtK(totalLikes), "suma"),
        kpiCard("Avg rate", fmtPct(avgRate*100), "promedio"),
      ].join("");

      applyTopFiltersAndRender();
    }

    let selectedDate = new Date();

    async function loadDate(d){
      const ymd = toYMD(d);
      const url = fileUrl(ymd); // reports/YYYY-MM-DD.json
      try{
        const raw = await fetchJson(url);
        const data = unwrapMakePayload(raw);
        if(!data) throw new Error("JSON inválido");
        render(data, ymd, url);
        selectedDate = d;
        return true;
      } catch(e){
        return false;
      }
    }

    async function loadWithFallback(startDate){
      for(let i=0; i<=MAX_FALLBACK_DAYS; i++){
        const d = addDays(startDate, -i);
        const ok = await loadDate(d);
        if(ok) return;
      }

      // Sin datos
      setText("filePill", "reports/YYYY-MM-DD.json (no encontrado)");
      setText("datePill", "día: —");
      setText("fetchPill", "sync: —");
      setText("srcPill", "fuente: —");
      setText("thr", "—");
      setText("metaCount", "0");
      document.getElementById("kpis").innerHTML = [
        kpiCard("Videos", "0", "dataset"),
        kpiCard("Views", "0", "suma"),
        kpiCard("Likes", "0", "suma"),
        kpiCard("Avg rate", "0%", "promedio"),
      ].join("");
      document.getElementById("topList").innerHTML = "";
      show(document.getElementById("topEmpty"), true);
      document.getElementById("creatorFilter").innerHTML = `<option value="">Todos los creadores</option>`;
    }

    // Events
    document.getElementById("btnToday").addEventListener("click", () => loadWithFallback(new Date()));
    document.getElementById("btnReload").addEventListener("click", () => loadWithFallback(selectedDate));
    document.getElementById("btnPrev").addEventListener("click", () => loadWithFallback(addDays(selectedDate, -1)));
    document.getElementById("btnNext").addEventListener("click", () => loadWithFallback(addDays(selectedDate, +1)));

    document.getElementById("q").addEventListener("input", (e)=>{
      UI_STATE.query = e.target.value || "";
      applyTopFiltersAndRender();
    });

    document.getElementById("creatorFilter").addEventListener("change", (e)=>{
      UI_STATE.selectedCreator = e.target.value || "";
      applyTopFiltersAndRender();
    });

    // Init
    loadWithFallback(new Date());
    setInterval(() => loadWithFallback(selectedDate), 10 * 60 * 1000);
  </script>
</body>
</html>
