<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TikTok Trends Panel</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,700,0,0" rel="stylesheet" />

  <style>
    :root{
      --bg0:#070812; --bg1:#0b1022;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --border:rgba(255,255,255,.16);
      --radius:18px;
      --shadow:0 14px 44px rgba(0,0,0,.55);
      --blur:14px;
      --max:1100px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 680px at 10% 0%, rgba(57,217,255,.22), transparent 58%),
        radial-gradient(900px 600px at 90% 0%, rgba(168,85,255,.18), transparent 60%),
        radial-gradient(900px 700px at 40% 105%, rgba(255,59,212,.16), transparent 60%),
        radial-gradient(700px 500px at 80% 90%, rgba(25,243,168,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .wrap{max-width:var(--max);margin:0 auto;padding:20px 14px 40px}
    @media (min-width:640px){.wrap{padding:28px 18px 46px}}
    .topbar{display:flex;flex-direction:column;gap:14px;margin-bottom:18px}
    @media (min-width:640px){.topbar{flex-direction:row;align-items:center;justify-content:space-between;gap:12px}}
    .brand{display:flex;align-items:center;gap:12px;min-width:0;flex:1 1 auto}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.26), transparent 42%),
        linear-gradient(135deg, rgba(57,217,255,.95), rgba(168,85,255,.85));
      box-shadow:0 18px 48px rgba(0,0,0,.60);
      display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,.20);
      position:relative;overflow:hidden;
    }
    .logo:after{
      content:"";position:absolute;inset:-55%;
      background:
        radial-gradient(circle at 25% 25%, rgba(255,59,212,.28), transparent 42%),
        radial-gradient(circle at 70% 70%, rgba(25,243,168,.18), transparent 46%);
      transform:rotate(18deg);filter:blur(1px);opacity:.9;
    }
    .logo .material-symbols-rounded{font-size:22px;color:rgba(0,0,0,.92);z-index:1}
    .titleblock{min-width:0}
    h1{font-size:16px;margin:0 0 2px;letter-spacing:-.02em;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    @media (min-width:640px){h1{font-size:18px}}
    .subtitle{font-size:11.5px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}
    @media (min-width:640px){.subtitle{font-size:12.5px;gap:10px}}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      backdrop-filter:blur(var(--blur));
    }
    .pill .material-symbols-rounded{font-size:16px;color:rgba(255,255,255,.70)}
    .actions{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;width:100%}
    @media (min-width:480px){.actions{display:flex;flex-wrap:wrap;justify-content:flex-end;width:auto;gap:10px}}
    button{
      cursor:pointer;border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);color:var(--text);
      padding:10px 12px;border-radius:14px;font-weight:800;letter-spacing:-.01em;
      display:inline-flex;align-items:center;justify-content:center;gap:6px;
      transition:transform .08s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
      backdrop-filter:blur(var(--blur));
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      font-size:12.5px;white-space:nowrap;
    }
    @media (min-width:480px){button{font-size:13.5px;gap:8px;padding:10px 14px}}
    button .material-symbols-rounded{font-size:18px;flex-shrink:0}
    @media (min-width:480px){button .material-symbols-rounded{font-size:20px}}
    button:hover{background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.22);box-shadow:0 14px 40px rgba(0,0,0,.45)}
    button:active{transform:translateY(1px)}
    .primary{
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 45%),
        linear-gradient(135deg, rgba(57,217,255,.95), rgba(255,59,212,.75));
      border-color:rgba(255,255,255,.22);
      color:rgba(0,0,0,.92);
    }
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-top:14px}
    @media (min-width:640px){.grid{gap:14px}}
    .card{
      grid-column:span 12;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.18);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:0 16px 48px rgba(0,0,0,.60);
      backdrop-filter:blur(var(--blur));
      position:relative;overflow:hidden;
    }
    @media (min-width:640px){.card{padding:18px}}
    .card:before{
      content:"";position:absolute;inset:-1px;
      background:
        radial-gradient(circle at 12% 20%, rgba(57,217,255,.12), transparent 26%),
        radial-gradient(circle at 85% 30%, rgba(168,85,255,.10), transparent 30%),
        radial-gradient(circle at 70% 85%, rgba(255,59,212,.10), transparent 30%),
        radial-gradient(circle at 30% 85%, rgba(25,243,168,.08), transparent 30%),
        radial-gradient(circle at 10% 70%, rgba(255,210,74,.07), transparent 28%);
      pointer-events:none;
    }
    .cardhead{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:12px;position:relative;z-index:1}
    .cardhead h2{font-size:13px;margin:0;color:rgba(255,255,255,.90);font-weight:900;letter-spacing:.09em;text-transform:uppercase}
    .hint{color:var(--muted2);font-size:12px;margin-top:2px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;font-size:12px;color:rgba(255,255,255,.74)}
    .kpis{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;position:relative;z-index:1}
    .kpi{
      grid-column:span 12;padding:14px;border-radius:16px;
      border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.18);
      display:flex;gap:12px;align-items:center;
    }
    .kpi .ic{
      width:40px;height:40px;border-radius:14px;display:flex;align-items:center;justify-content:center;
      background:rgba(57,217,255,.16);border:1px solid rgba(57,217,255,.26);
      box-shadow:0 12px 32px rgba(0,0,0,.35);
    }
    .kpi .ic.purple{background:rgba(168,85,255,.16);border-color:rgba(168,85,255,.26)}
    .kpi .ic .material-symbols-rounded{color:rgba(255,255,255,.92)}
    .kpi .label{color:var(--muted);font-size:12.5px;font-weight:800}
    .kpi .val{font-size:20px;font-weight:950;letter-spacing:-.03em;margin-top:2px}
    .col6{grid-column:span 12}
    @media (min-width:860px){.kpi{grid-column:span 6}.col6{grid-column:span 12}}
    .list{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:10px;position:relative;z-index:1}
    .item{
      padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.20);display:flex;gap:10px;align-items:flex-start;
      transition:background .2s ease, border-color .2s ease;
      flex-wrap:nowrap;position:relative;
    }
    @media (min-width:640px){.item{padding:14px;gap:12px;border-radius:16px}}
    .item:hover{background:rgba(0,0,0,.24);border-color:rgba(255,255,255,.22)}
    .item.top1{
      border:2px solid rgba(255,193,7,.40);
      background:rgba(0,0,0,.25);
      box-shadow:0 0 20px rgba(255,193,7,.15), 0 8px 32px rgba(0,0,0,.50);
    }
    .item.top1:before{
      content:"";position:absolute;inset:0;border-radius:14px;
      padding:2px;background:conic-gradient(from 0deg, 
        rgba(255,193,7,1) 0deg, 
        rgba(255,235,59,.6) 90deg, 
        rgba(255,193,7,.4) 180deg, 
        rgba(255,235,59,.6) 270deg, 
        rgba(255,193,7,1) 360deg);
      -webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);
      mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;mask-composite:exclude;
      animation:top1Border 3s linear infinite;
      z-index:-1;
    }
    @media (min-width:640px){.item.top1:before{border-radius:16px}}
    @keyframes top1Border{
      0%{transform:rotate(0deg);opacity:.85}
      50%{opacity:1}
      100%{transform:rotate(360deg);opacity:.85}
    }
    .item.top1:after{
      content:"";position:absolute;inset:-4px;border-radius:16px;
      background:radial-gradient(circle, rgba(255,193,7,.3) 0%, transparent 70%);
      animation:top1Glow 2s ease-in-out infinite;
      z-index:-2;pointer-events:none;
    }
    @media (min-width:640px){.item.top1:after{border-radius:18px}}
    @keyframes top1Glow{
      0%,100%{opacity:.4;transform:scale(1)}
      50%{opacity:.7;transform:scale(1.02)}
    }
    .top1Tag{
      position:absolute;top:-12px;left:50%;transform:translateX(-50%);
      background:linear-gradient(135deg, rgba(255,193,7,.95), rgba(255,235,59,.85));
      color:rgba(0,0,0,.95);font-weight:950;font-size:10px;
      padding:4px 12px;border-radius:12px;
      border:2px solid rgba(255,255,255,.30);
      box-shadow:0 4px 16px rgba(255,193,7,.50), 0 0 20px rgba(255,193,7,.30);
      display:flex;align-items:center;gap:4px;letter-spacing:.08em;
      text-transform:uppercase;z-index:10;white-space:nowrap;
      animation:top1TagPulse 2s ease-in-out infinite;
    }
    @media (min-width:640px){.top1Tag{font-size:11px;padding:5px 14px;top:-14px}}
    @keyframes top1TagPulse{
      0%,100%{transform:translateX(-50%) scale(1);box-shadow:0 4px 16px rgba(255,193,7,.50), 0 0 20px rgba(255,193,7,.30)}
      50%{transform:translateX(-50%) scale(1.05);box-shadow:0 6px 20px rgba(255,193,7,.70), 0 0 30px rgba(255,193,7,.50)}
    }
    .top1Tag .material-symbols-rounded{
      font-size:14px;animation:top1Fire 1.5s ease-in-out infinite;
    }
    @media (min-width:640px){.top1Tag .material-symbols-rounded{font-size:16px}}
    @keyframes top1Fire{
      0%,100%{transform:scale(1) rotate(0deg);opacity:1}
      25%{transform:scale(1.1) rotate(-5deg);opacity:.9}
      50%{transform:scale(1.15) rotate(5deg);opacity:1}
      75%{transform:scale(1.1) rotate(-3deg);opacity:.95}
    }
    .badge.top1Badge{
      background:linear-gradient(135deg, rgba(255,193,7,1), rgba(255,235,59,.9));
      box-shadow:0 0 20px rgba(255,193,7,.60), 0 8px 24px rgba(0,0,0,.40);
      animation:top1BadgeGlow 2s ease-in-out infinite;
    }
    @keyframes top1BadgeGlow{
      0%,100%{box-shadow:0 0 20px rgba(255,193,7,.60), 0 8px 24px rgba(0,0,0,.40)}
      50%{box-shadow:0 0 30px rgba(255,193,7,.90), 0 10px 32px rgba(0,0,0,.50)}
    }
    .badge{
      min-width:26px;height:26px;border-radius:8px;display:flex;align-items:center;justify-content:center;
      font-weight:950;color:rgba(0,0,0,.92);
      background:linear-gradient(135deg, rgba(57,217,255,.98), rgba(255,59,212,.78));
      border:1px solid rgba(255,255,255,.22);font-size:11px;
      box-shadow:0 12px 28px rgba(0,0,0,.30);flex:0 0 auto;
    }
    @media (min-width:640px){.badge{min-width:28px;height:28px;border-radius:10px;font-size:12px}}
    .thumb{
      width:80px;height:112px;border-radius:12px;overflow:hidden;
      border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.22);
      flex:0 0 auto;box-shadow:0 12px 28px rgba(0,0,0,.30);
      position:relative;cursor:pointer;transition:transform .2s ease, box-shadow .2s ease;
    }
    @media (min-width:640px){.thumb{width:96px;height:136px;border-radius:16px}}
    .thumb:hover{transform:scale(1.02);box-shadow:0 16px 36px rgba(0,0,0,.40)}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .thumb .playBtn{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,.45);opacity:0;transition:opacity .2s ease;
      pointer-events:none;
    }
    .thumb:hover .playBtn{opacity:1}
    .thumb .playBtn .material-symbols-rounded{
      font-size:36px;color:rgba(255,255,255,.95);
      filter:drop-shadow(0 4px 12px rgba(0,0,0,.60));
    }
    @media (min-width:640px){.thumb .playBtn .material-symbols-rounded{font-size:48px}}
    .kv.likes{
      background:rgba(255,82,82,.15);border-color:rgba(255,82,82,.25);
    }
    .kv.likes b{color:rgba(255,150,150,.95)}
    .kv.likes span{color:rgba(255,180,180,.85)}
    .text{font-size:12.5px;color:rgba(255,255,255,.90);line-height:1.35;overflow-wrap:anywhere;word-break:break-word;flex:1 1 auto;min-width:0;width:100%;display:flex;flex-direction:column;align-items:flex-end}
    .text > div:first-child{align-self:flex-start;width:100%}
    @media (min-width:640px){.text{font-size:13.5px;width:auto}}
    .rows{display:flex;flex-direction:column;gap:8px;margin-top:8px;width:100%}
    .row{display:flex;gap:8px;flex-wrap:wrap;color:rgba(255,255,255,.82);font-size:11.5px;justify-content:flex-end;width:100%}
    @media (min-width:640px){.row{gap:10px;font-size:12.5px;justify-content:flex-end}}
    .kv{
      display:inline-flex;gap:5px;align-items:center;padding:6px 9px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);
      font-size:11px;
    }
    @media (min-width:640px){.kv{gap:6px;padding:7px 10px;font-size:12.5px}}
    .kv b{color:rgba(255,255,255,.92);font-weight:950}
    .kv span{color:rgba(255,255,255,.72);font-weight:800;display:inline-flex;align-items:center;gap:6px}
    .kv .material-symbols-rounded{font-size:14px;opacity:.95}
    @media (min-width:640px){.kv .material-symbols-rounded{font-size:16px}}
    .btnLink{
      display:inline-flex;align-items:center;justify-content:center;margin-top:10px;padding:10px;border-radius:12px;
      text-decoration:none;font-weight:950;letter-spacing:-.01em;color:rgba(0,0,0,.92);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 46%),
        linear-gradient(135deg, rgba(57,217,255,.96), rgba(168,85,255,.86));
      border:1px solid rgba(255,255,255,.20);
      box-shadow:0 14px 36px rgba(0,0,0,.45);
      transition:transform .08s ease, filter .2s ease, box-shadow .2s ease;
      width:fit-content;align-self:flex-end;margin-left:auto;
    }
    @media (min-width:640px){.btnLink{padding:12px}}
    .btnLink:hover{filter:brightness(1.04);box-shadow:0 18px 44px rgba(0,0,0,.55);transform:scale(1.05)}
    .btnLink:active{transform:translateY(1px) scale(1.02)}
    .btnLink .material-symbols-rounded{font-size:22px}
    @media (min-width:640px){.btnLink .material-symbols-rounded{font-size:24px}}
    .empty{
      border:1px dashed rgba(255,255,255,.20);background:rgba(0,0,0,.16);
      padding:14px;border-radius:16px;color:var(--muted);line-height:1.35;font-size:13px;position:relative;z-index:1;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"><span class="material-symbols-rounded">sensors</span></div>
        <div class="titleblock">
          <h1>TikTok Trends Panel</h1>
          <div class="subtitle">
            <span class="pill" style="display:none;"><span class="material-symbols-rounded">folder</span><span id="src">reports/—.json</span></span>
            <span class="pill"><span class="material-symbols-rounded">event</span><span id="dateLabel">—</span></span>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="btnPrev"><span class="material-symbols-rounded">chevron_left</span>día anterior</button>
        <button id="btnNext"><span class="material-symbols-rounded">chevron_right</span>día siguiente</button>
        <button class="primary" id="btnToday"><span class="material-symbols-rounded">today</span>hoy</button>
        <button id="btnReload"><span class="material-symbols-rounded">refresh</span>recargar</button>
      </div>
    </div>

    <div class="grid">
      <div class="card col6">
        <div class="cardhead">
          <div>
            <h2>Top videos</h2>
            <div class="hint">Tiktoks replicables.</div>
          </div>
        </div>
        <ul class="list" id="listTopLikes"></ul>
        <div id="emptyTopLikes" class="empty" style="display:none;">No hay items válidos.</div>
      </div>
    </div>

  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const MAX_TOP = 10;

    // ====== NAV ======
    const REPORTS_DIR = "reports";
    const MAX_FALLBACK_DAYS = 14;

    // Inyección opcional: {text:"..."}
    const BUNDLE_PAYLOAD = null;

    // =========================
    // Helpers
    // =========================
    const pad2 = (n) => String(n).padStart(2, "0");
    const toYMD = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const addDays = (d, days) => { const x = new Date(d); x.setDate(x.getDate() + days); return x; };

    function setText(id, val){ document.getElementById(id).textContent = (val ?? "—"); }
    function show(el, yes){ el.style.display = yes ? "" : "none"; }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function fmtInt(n){
      const x = Number(n);
      if(!Number.isFinite(x)) return "0";
      return x.toLocaleString("es-CO");
    }

    function fmtPctNoDecimals(n){
      const x = Number(n);
      if(!Number.isFinite(x)) return "0%";
      return `${Math.round(x)}%`;
    }

    function safeNum(x){
      const s = String(x ?? "").trim();
      if(!s) return 0;
      const n = Number(s.replace(/[^\d.-]/g, ""));
      return Number.isFinite(n) ? n : 0;
    }

    function getVideoIdFromUrl(url){
      const s = String(url || "");
      const m = s.match(/\/video\/(\d+)/);
      return m ? m[1] : "";
    }

    // =========================
    // Parse & sanitize
    // Reglas anti-basura:
    // - debe tener url + video_id + username
    // - debe tener views>0 o likes>0 (evita itsmiawaifu 0/0)
    // =========================
    function parseItemsFromText(htmlText, errors){
      const out = [];
      const tmp = document.createElement("div");
      tmp.innerHTML = String(htmlText || "");

      const lis = Array.from(tmp.querySelectorAll("li"));
      for (let i=0; i<lis.length; i++){
        const li = lis[i];

        const anchors = Array.from(li.querySelectorAll("a"));
        const urlA = anchors.find(a => {
          const h = (a.getAttribute("href") || "").trim();
          return /tiktok\.com/i.test(h) && /\/video\/\d+/.test(h);
        });
        const url = (urlA ? (urlA.getAttribute("href") || "") : "").trim();

        const coverA = anchors.find(a => /tiktokcdn/i.test((a.getAttribute("href") || "").trim()));
        const cover_url = (coverA ? (coverA.getAttribute("href") || "") : "").trim();

        const strongs = Array.from(li.querySelectorAll("strong")).map(s => (s.textContent || "").trim());
        const username = (strongs[0] || "").replace(/^@/,"").trim();
        const views = safeNum(strongs[1]);
        const likes = safeNum(strongs[2]);

        const video_id = getVideoIdFromUrl(url);

        // descarta basura (incluye caso 0/0)
        if(!url || !video_id || !username) continue;
        if(views <= 0 && likes <= 0) continue;

        // si algo raro, lo marcamos pero no rompemos
        if(!cover_url) errors.push(`item_${i+1}_no_cover`);

        out.push({ url, cover_url, username, video_id, views, likes });
      }
      return out;
    }

    // =========================
    // Dedupe by video_id
    // =========================
    function dedupeByVideoId(items){
      const map = new Map();
      for(const it of items){
        const key = it.video_id || "";
        if(!key) continue;
        if(!map.has(key)){
          map.set(key, it); // (corregido)
        } else {
          const cur = map.get(key);
          if((it.views > cur.views) || (it.views === cur.views && it.likes > cur.likes)){
            map.set(key, it);
          }
        }
      }
      return Array.from(map.values());
    }

    function computeLikeRate(it){
      const v = safeNum(it.views);
      const l = safeNum(it.likes);
      const like_rate = v > 0 ? (l / v) : 0;
      const like_rate_pct = Math.round(like_rate * 100000) / 1000; // 3 decimals
      return { like_rate, like_rate_pct };
    }

    function sortTopLikes(items){
      return [...items].sort((a,b)=>{
        const la = safeNum(a.likes), lb = safeNum(b.likes);
        if(lb !== la) return lb - la;
        const va = safeNum(a.views), vb = safeNum(b.views);
        if(vb !== va) return vb - va;
        return String(a.video_id||"").localeCompare(String(b.video_id||""));
      });
    }

    // =========================
    // Rendering
    // =========================
    function makeVideoItem(v, idx){
      const rank = idx + 1;
      const url = v.url || "";
      const user = v.username || "";
      const views = v.views ?? 0;
      const likes = v.likes ?? 0;
      const cover = v.cover_url || "";

      const li = document.createElement("li");
      li.className = rank === 1 ? "item top1" : "item";
      li.innerHTML = `
        ${rank === 1 ? `<div class="top1Tag"><span class="material-symbols-rounded">local_fire_department</span>TOP 1 LAST 24 HOURS</div>` : ``}
        <div class="badge ${rank === 1 ? 'top1Badge' : ''}">${escapeHtml(String(rank))}</div>
        ${cover ? `<a href="${escapeHtml(url)}" target="_blank" rel="noopener" class="thumb"><img src="${escapeHtml(cover)}" alt="cover" referrerpolicy="no-referrer"><div class="playBtn"><span class="material-symbols-rounded">play_circle</span></div></a>` : ``}
        <div class="text">
          <div style="font-weight:950; letter-spacing:-0.01em;">@${escapeHtml(user || "—")}</div>
          <div class="rows">
            <div class="row">
              <span class="kv"><span><span class="material-symbols-rounded">play_circle</span>views</span> <b>${escapeHtml(fmtInt(views))}</b></span>
              <span class="kv likes"><span><span class="material-symbols-rounded">favorite</span>likes</span> <b>${escapeHtml(fmtInt(likes))}</b></span>
            </div>
          </div>
          <a class="btnLink" href="${escapeHtml(url)}" target="_blank" rel="noopener" title="Abrir en TikTok">
            <span class="material-symbols-rounded">open_in_new</span>
          </a>
        </div>
      `;
      return li;
    }

    function renderList(listId, emptyId, arr, itemFactory){
      const ul = document.getElementById(listId);
      ul.innerHTML = "";
      if(Array.isArray(arr) && arr.length){
        arr.forEach((x, i)=> ul.appendChild(itemFactory(x, i)));
        show(document.getElementById(emptyId), false);
      }else{
        show(document.getElementById(emptyId), true);
      }
    }

    // =========================
    // Load JSON from reports/AAAA-MM-DD.json
    // Supports:
    // 1) {text:"..."}
    // 2) [{json:"{...}"}]
    // =========================
    function unwrapMake(payload){
      if (Array.isArray(payload) && payload.length && payload[0] && typeof payload[0] === "object") {
        if (typeof payload[0].json === "string") {
          try { return JSON.parse(payload[0].json); } catch(e) { return null; }
        }
      }
      return payload;
    }

    function fileUrl(ymd){ return `${REPORTS_DIR}/${ymd}.json`; }

    async function fetchJson(url){
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return await res.json();
    }

    // ====== NAV state ======
    let selectedDate = new Date();

    async function loadDate(d){
      const errors = [];
      const ymd = toYMD(d);
      const url = fileUrl(ymd);

      setText("dateLabel", ymd);

      try{
        const raw = BUNDLE_PAYLOAD ? BUNDLE_PAYLOAD : await fetchJson(url);
        const obj = unwrapMake(raw);
        if(!obj || typeof obj !== "object") throw new Error("payload inválido (json)");
        const htmlText = String(obj.text || "");
        if(!htmlText) throw new Error("falta obj.text con los <li>");

        let items = parseItemsFromText(htmlText, errors);

        items = items.map(it => {
          const { like_rate, like_rate_pct } = computeLikeRate(it);
          return { ...it, like_rate, like_rate_pct };
        });

        const before = items.length;
        items = dedupeByVideoId(items);
        const after = items.length;

        const topLikes = sortTopLikes(items).slice(0, MAX_TOP);

        renderList("listTopLikes", "emptyTopLikes", topLikes, makeVideoItem);

        selectedDate = d;
        return true;
      } catch(e){
        return false;
      }
    }

    async function loadWithFallback(startDate){
      for(let i=0; i<=MAX_FALLBACK_DAYS; i++){
        const d = addDays(startDate, -i);
        const ok = await loadDate(d);
        if(ok) return;
      }

      document.getElementById("listTopLikes").innerHTML = "";
      show(document.getElementById("emptyTopLikes"), true);
    }

    document.getElementById("btnToday").addEventListener("click", () => loadWithFallback(new Date()));
    document.getElementById("btnReload").addEventListener("click", () => loadWithFallback(selectedDate));
    document.getElementById("btnPrev").addEventListener("click", () => loadWithFallback(addDays(selectedDate, -1)));
    document.getElementById("btnNext").addEventListener("click", () => loadWithFallback(addDays(selectedDate, +1)));

    loadWithFallback(new Date());
    setInterval(() => loadWithFallback(selectedDate), 10 * 60 * 1000);
  </script>
</body>
</html>
