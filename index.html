
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trendfinder TikTok</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #070A12;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.04);
      --stroke: rgba(255,255,255,0.10);
      --stroke2: rgba(255,255,255,0.16);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);
      --muted2: rgba(255,255,255,0.44);

      --sky: #39D6FF;
      --purple: #A855F7;
      --pink: #FF3EA5;
      --lime: #9EFF7A;
      --amber: #FFC857;

      --shadow: 0 14px 50px rgba(0,0,0,0.55);
      --radius: 18px;
      --radius2: 14px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(57,214,255,0.14), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(168,85,247,0.16), transparent 62%),
        radial-gradient(900px 700px at 40% 115%, rgba(255,62,165,0.10), transparent 60%),
        linear-gradient(180deg, #050712 0%, #070A12 50%, #04050B 100%);
      color: var(--text);
      overflow-x:hidden;
    }

    /* Subtle memphis shapes */
    .memphis{
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:0.55;
      z-index:0;
      filter: blur(0.2px);
    }
    .shape{
      position:absolute;
      border: 1px solid rgba(255,255,255,0.09);
      background: rgba(255,255,255,0.02);
      border-radius: 999px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.35);
    }
    .shape.s1{ width:220px; height:220px; left:-60px; top:110px; border-color: rgba(57,214,255,0.25); }
    .shape.s2{ width:180px; height:180px; right:-70px; top:180px; border-color: rgba(168,85,247,0.24); }
    .shape.s3{ width:120px; height:120px; left:18%; bottom:90px; border-color: rgba(255,62,165,0.22); border-radius: 22px; transform: rotate(14deg); }
    .shape.s4{ width:260px; height:120px; right:10%; bottom:40px; border-color: rgba(57,214,255,0.18); border-radius: 26px; transform: rotate(-10deg); }
    .dots{
      position:absolute; left:55%; top:38%;
      width:220px; height:120px;
      background-image: radial-gradient(rgba(255,255,255,0.12) 1.2px, transparent 1.2px);
      background-size: 14px 14px;
      opacity:0.35;
      border-radius: 20px;
      border: 1px dashed rgba(255,255,255,0.08);
      transform: rotate(6deg);
    }

    a{ color: inherit; text-decoration:none; }
    .container{
      position:relative;
      z-index:1;
      width: min(1180px, calc(100% - 36px));
      margin: 0 auto;
      padding: 22px 0 60px;
    }

    .topbar{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      padding: 18px 18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.04));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 240px;
    }
    .logo{
      width:40px;height:40px;border-radius: 12px;
      background:
        radial-gradient(14px 14px at 30% 30%, rgba(57,214,255,0.9), transparent 55%),
        radial-gradient(18px 18px at 70% 70%, rgba(168,85,247,0.85), transparent 55%),
        linear-gradient(135deg, rgba(255,62,165,0.18), rgba(57,214,255,0.14));
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 18px 60px rgba(0,0,0,0.45);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset: 9px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.02);
    }

    .brand h1{
      margin:0;
      font-size: 15px;
      letter-spacing: 0.2px;
      line-height:1.1;
      font-weight: 700;
    }
    .brand p{
      margin:3px 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    .controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      width: 100%;
    }
    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(0,0,0,0.28);
      border: 1px solid var(--stroke);
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }
    .chip b{ color: var(--text); font-weight: 600; }
    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.03);
      color: var(--muted);
      font-size: 12px;
    }

    .input, select{
      height: 38px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      padding: 0 12px;
      font-size: 13px;
      outline:none;
      transition: border .15s ease, background .15s ease;
      min-width: 210px;
    }
    .input:focus, select:focus{
      border-color: rgba(57,214,255,0.45);
      background: rgba(255,255,255,0.06);
    }
    select{ min-width: 210px; }

    .btn{
      height: 38px;
      padding: 0 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(57,214,255,0.16), rgba(168,85,247,0.10));
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: transform .12s ease, border .15s ease, background .15s ease;
      display:flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,0.20); }
    .btn:active{ transform: translateY(0px); }

    .grid{
      margin-top: 16px;
      display:grid;
      gap:14px;
      grid-template-columns: 1.1fr 0.9fr;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.035));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .cardHeader{
      padding: 14px 16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .cardTitle{
      margin:0;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.15px;
    }
    .cardSub{
      margin:6px 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
    .cardBody{ padding: 14px 16px; }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
    }
    .kpi{
      padding: 12px 12px;
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      min-height: 74px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .kpi .label{
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 0.25px;
    }
    .kpi .value{
      margin-top: 8px;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 0.2px;
    }
    .kpi .hint{
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted2);
      font-family: var(--mono);
    }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .item{
      display:flex;
      gap:12px;
      align-items:flex-start;
      padding: 12px 12px;
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
    }
    .badge{
      min-width: 34px; height: 34px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 800;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--text);
    }
    .badge.sky{ border-color: rgba(57,214,255,0.35); box-shadow: 0 0 0 4px rgba(57,214,255,0.08) inset; }
    .badge.purple{ border-color: rgba(168,85,247,0.35); box-shadow: 0 0 0 4px rgba(168,85,247,0.08) inset; }
    .badge.pink{ border-color: rgba(255,62,165,0.35); box-shadow: 0 0 0 4px rgba(255,62,165,0.08) inset; }
    .badge.lime{ border-color: rgba(158,255,122,0.35); box-shadow: 0 0 0 4px rgba(158,255,122,0.08) inset; }

    .itemMain{ flex:1; min-width:0; }
    .itemTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .itemTitle{
      font-size: 13px;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .itemTitle a{
      color: var(--text);
      text-decoration: none;
    }
    .itemTitle a:hover{
      color: rgba(57,214,255,0.95);
      text-decoration: underline;
    }
    .itemMeta{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .metaTag{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(255,255,255,0.72);
    }
    .dot{
      width:7px; height:7px; border-radius: 99px;
      background: rgba(255,255,255,0.22);
    }
    .dot.sky{ background: rgba(57,214,255,0.85); }
    .dot.purple{ background: rgba(168,85,247,0.85); }
    .dot.pink{ background: rgba(255,62,165,0.85); }
    .dot.lime{ background: rgba(158,255,122,0.85); }
    .dot.amber{ background: rgba(255,200,87,0.85); }

    .table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0 10px;
    }
    .table th{
      text-align:left;
      font-size: 11px;
      color: var(--muted);
      font-weight: 600;
      padding: 0 10px 6px;
      letter-spacing: 0.25px;
    }
    .table td{
      padding: 12px 10px;
      font-size: 12px;
      border-top: 1px solid rgba(255,255,255,0.10);
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
    .table tr td:first-child{
      border-left: 1px solid rgba(255,255,255,0.10);
      border-top-left-radius: 14px;
      border-bottom-left-radius: 14px;
    }
    .table tr td:last-child{
      border-right: 1px solid rgba(255,255,255,0.10);
      border-top-right-radius: 14px;
      border-bottom-right-radius: 14px;
    }

    .muted{ color: var(--muted); }
    .mono{ font-family: var(--mono); }
    .right{ text-align:right; }
    .nowrap{ white-space:nowrap; }

    .stack{
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .notice{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }
    .notice b{ color: var(--text); font-weight: 700; }

    .footer{
      margin-top: 16px;
      color: var(--muted2);
      font-size: 12px;
      text-align:center;
    }

    .seg{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top: 10px;
    }
    .seg button{
      height: 34px;
      padding: 0 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.72);
      font-size: 12px;
      cursor:pointer;
      transition: border .15s ease, background .15s ease, transform .12s ease;
    }
    .seg button:hover{ border-color: rgba(255,255,255,0.18); transform: translateY(-1px); }
    .seg button.active{
      border-color: rgba(57,214,255,0.35);
      background: rgba(57,214,255,0.10);
      color: var(--text);
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .brand{ min-width: auto; }
      .controls{ justify-content:flex-start; }
      .input, select{ min-width: 180px; flex: 1; }
    }
    @media (max-width: 540px){
      .topbar{ padding: 14px 14px; }
      .kpis{ grid-template-columns: 1fr; }
      .split{ grid-template-columns: 1fr; }
      .itemTop{ flex-direction:column; align-items:flex-start; }
    }
  </style>
</head>

<body>
  <div class="memphis" aria-hidden="true">
    <div class="shape s1"></div>
    <div class="shape s2"></div>
    <div class="shape s3"></div>
    <div class="shape s4"></div>
    <div class="dots"></div>
  </div>

  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Trendfinder TikTok</h1>
          <p id="subtitle">Panel de rendimiento y rankings diarios</p>
        </div>
      </div>

      <div class="controls">
        <div class="chip"><span class="dot sky"></span><span>Fecha:</span> <b id="metaDate">—</b></div>
        <div class="chip"><span class="dot purple"></span><span>Items:</span> <b id="metaCount">0</b></div>
        <input id="q" class="input" placeholder="Buscar por @usuario o video_id…" />
        <select id="creatorFilter">
          <option value="">Todos los creadores</option>
        </select>
        <select id="sortBy">
          <option value="likes_desc">Orden: Likes ↓</option>
          <option value="views_desc">Orden: Views ↓</option>
          <option value="like_rate_desc">Orden: Like rate ↓</option>
          <option value="rank_input_asc">Orden: Rank input ↑</option>
        </select>
        <button class="btn" id="reloadBtn" type="button">Recargar JSON</button>
      </div>
    </div>

    <div class="grid">
      <!-- Left column -->
      <div class="stack">
        <div class="card">
          <div class="cardHeader">
            <div>
              <div class="cardTitle">Overview</div>
              <div class="cardSub" id="overviewText">KPIs del dataset + highlights de interacción.</div>
              <div class="seg" id="viewTabs">
                <button class="active" data-tab="topLikes">Top por likes</button>
                <button data-tab="topRate">Top por like rate</button>
                <button data-tab="allVideos">Todos los videos</button>
                <button data-tab="creators">Creadores</button>
                <button data-tab="outliers">Outliers</button>
              </div>
            </div>
            <div class="pill mono" id="thresholdPill">umbral: —</div>
          </div>
          <div class="cardBody">
            <div class="kpis" id="kpis"></div>
          </div>
        </div>

        <div class="card" id="tab_topLikes">
          <div class="cardHeader">
            <div>
              <div class="cardTitle">Ranking de videos (Likes / Interacción)</div>
              <div class="cardSub">Los que “mandaron la parada” hoy por likes.</div>
            </div>
            <div class="pill mono" id="topLikesHint">top: —</div>
          </div>
          <div class="cardBody">
            <div class="list" id="topLikesList"></div>
          </div>
        </div>

        <div class="card" id="tab_topRate" style="display:none;">
          <div class="cardHeader">
            <div>
              <div class="cardTitle">Ranking de videos (Like rate)</div>
              <div class="cardSub">Eficiencia de likes sobre views (filtrado por umbral).</div>
            </div>
            <div class="pill mono" id="topRateHint">candidatos: —</div>
          </div>
          <div class="cardBody">
            <div class="list" id="topRateList"></div>
          </div>
        </div>

        <div class="card" id="tab_allVideos" style="display:none;">
          <div class="cardHeader">
            <div>
              <div class="cardTitle">Todos los videos</div>
              <div class="cardSub">Dataset completo con búsqueda, filtro y orden.</div>
            </div>
            <div class="pill mono" id="allCountPill">mostrando: —</div>
          </div>
          <div class="cardBody">
            <table class="table" id="videosTable">
              <thead>
                <tr>
                  <th class="nowrap">#</th>
                  <th>Video</th>
                  <th class="right nowrap">Views</th>
                  <th class="right nowrap">Likes</th>
                  <th class="right nowrap">Like rate</th>
                </tr>
              </thead>
              <tbody id="videosTbody"></tbody>
            </table>
          </div>
        </div>

        <div class="card" id="tab_creators" style="display:none;">
          <div class="cardHeader">
            <div>
              <div class="cardTitle">Ranking de creadores</div>
              <div class="cardSub">Quién domina el día por volumen en top + acumulados.</div>
            </div>
            <div class="pill mono" id="creatorCountPill">—</div>
          </div>
          <div class="cardBody">
            <table class="table">
              <thead>
                <tr>
                  <th class="nowrap">Rank</th>
                  <th>Creador</th>
                  <th class="right nowrap">Top count</th>
                  <th class="right nowrap">Likes</th>
                  <th class="right nowrap">Views</th>
                  <th class="right nowrap">Avg rate</th>
                </tr>
              </thead>
              <tbody id="creatorsTbody"></tbody>
            </table>
          </div>
        </div>

        <div class="card" id="tab_outliers" style="display:none;">
          <div class="cardHeader">
            <div>
              <div class="cardTitle">Outliers</div>
              <div class="cardSub">Picos raros por views o por tasa de likes.</div>
            </div>
            <div class="pill mono" id="outlierPill">—</div>
          </div>
          <div class="cardBody">
            <div class="split">
              <div>
                <div class="notice" style="margin-bottom:10px;"><b>Por views</b> (top alto)</div>
                <div class="list" id="outViews"></div>
              </div>
              <div>
                <div class="notice" style="margin-bottom:10px;"><b>Por like rate</b> (top alto)</div>
                <div class="list" id="outRate"></div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Right column -->
      <div class="stack">
        <div class="card">
          <div class="cardHeader">
            <div>
              <div class="cardTitle">Resumen</div>
              <div class="cardSub">Texto ejecutivo del análisis.</div>
            </div>
            <div class="pill mono">v2 (determinístico)</div>
          </div>
          <div class="cardBody">
            <div class="notice" id="resumenBox">—</div>
            <div style="height:12px;"></div>
            <div class="notice">
              <b>Insights</b>
              <div id="insightsBox" style="margin-top:8px; display:flex; flex-direction:column; gap:8px;"></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardHeader">
            <div>
              <div class="cardTitle">Acciones recomendadas</div>
              <div class="cardSub">Qué haría hoy con esta data.</div>
            </div>
            <div class="pill mono" id="actionsPill">—</div>
          </div>
          <div class="cardBody">
            <div class="list" id="actionsList"></div>
          </div>
        </div>

        <div class="card">
          <div class="cardHeader">
            <div>
              <div class="cardTitle">Notas de parseo</div>
              <div class="cardSub">Transparencia del pipeline.</div>
            </div>
            <div class="pill mono" id="sourcePill">fuente: —</div>
          </div>
          <div class="cardBody">
            <div class="list" id="notesList"></div>
          </div>
        </div>

        <div class="footer">Trendfinder TikTok · dashboard responsive · rankings en JS</div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // 1) PEGA AQUI EL JSON REAL
    //    Formatos soportados:
    //    A) [{result:"{...}"}]
    //    B) {result:"{...}"}
    //    C) {meta, parametros, data:{videos:[...]}}
    // =========================
    window.__TREND_DATA__ = [
      {
        "result": "{\"meta\":{\"fecha_procesamiento\":\"\",\"fuente\":\"\",\"total_items_input\":18,\"total_items_dedup\":18,\"notas_parseo\":[]},\"parametros\":{\"umbral_views_like_rate\":10000,\"definicion_score_interaccion\":\"score_interaccion = likes\"},\"data\":{\"videos\":[]}}"
      }
    ];

    // =========================
    // Helpers
    // =========================
    function safeNum(n){ return Number.isFinite(+n) ? +n : 0; }
    function safeStr(s){ return (typeof s === "string") ? s : ""; }

    function fmtK(n){
      n = safeNum(n);
      const abs = Math.abs(n);
      if (abs >= 1e9) return (n/1e9).toFixed(2).replace(/\.00$/,"") + "B";
      if (abs >= 1e6) return (n/1e6).toFixed(2).replace(/\.00$/,"") + "M";
      if (abs >= 1e3) return (n/1e3).toFixed(1).replace(/\.0$/,"") + "K";
      return String(Math.round(n));
    }

    // pct is in "percent points" (e.g., 11.116 => "11.116%")
    function fmtPct(p){
      p = safeNum(p);
      return (Math.round(p*1000)/1000).toFixed(3).replace(/\.000$/,"") + "%";
    }

    function parseIncoming(raw){
      try{
        if (Array.isArray(raw) && raw.length){
          const first = raw[0] || {};
          if (typeof first.result === "string" && first.result.trim().startsWith("{")){
            return JSON.parse(first.result);
          }
          if (first.meta && first.data) return first;
        }
        if (raw && typeof raw === "object"){
          if (typeof raw.result === "string" && raw.result.trim().startsWith("{")){
            return JSON.parse(raw.result);
          }
          if (raw.meta && raw.data) return raw;
        }
      }catch(e){}
      return {
        meta: { fecha_procesamiento:"", fuente:"", total_items:0, notas_parseo:[] },
        parametros: { definicion_score_interaccion:"score_interaccion = likes", umbral_views_like_rate:0, MIN_VIEWS_FOR_RATE:0 },
        data: { videos:[] }
      };
    }

    function uniq(arr){
      const s = new Set();
      const out = [];
      for (const x of arr){
        const k = String(x);
        if (!s.has(k)){ s.add(k); out.push(x); }
      }
      return out;
    }

    function colorBadge(i){
      const classes = ["sky","purple","pink","lime"];
      return classes[i % classes.length];
    }

    function el(tag, attrs={}, children=[]){
      const node = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)){
        if (k === "class") node.className = v;
        else if (k === "html") node.innerHTML = v;
        else node.setAttribute(k, v);
      }
      for (const c of children){
        if (typeof c === "string") node.appendChild(document.createTextNode(c));
        else if (c) node.appendChild(c);
      }
      return node;
    }

    function clamp(n, a, b){ n = safeNum(n); return Math.max(a, Math.min(b, n)); }

    function getThreshold(json){
      const p = json.parametros || {};
      const a = safeNum(p.umbral_views_like_rate);
      const b = safeNum(p.MIN_VIEWS_FOR_RATE);
      return a || b || 0;
    }

    function normalizeVideos(json){
      const raw = (json.data && Array.isArray(json.data.videos)) ? json.data.videos : [];
      // Dedup por url (estable)
      const seen = new Set();
      const out = [];
      for (const v of raw){
        const url = safeStr(v.url);
        const key = url || (safeStr(v.username) + "|" + safeStr(v.video_id));
        if (!key) continue;
        if (seen.has(key)) continue;
        seen.add(key);

        const views = safeNum(v.views);
        const likes = safeNum(v.likes);

        const like_rate = (views > 0) ? (likes / views) : 0;
        const like_rate_pct = like_rate * 100;

        out.push({
          rank_input: safeNum(v.rank_input),
          url,
          username: safeStr(v.username),
          video_id: safeStr(v.video_id),
          region: safeStr(v.region),
          views,
          likes,
          score_interaccion: likes, // tu definición actual
          like_rate,
          like_rate_pct
        });
      }
      return out;
    }

    function sortByMany(arr, ...comparators){
      const a = arr.slice();
      a.sort((x,y)=>{
        for (const cmp of comparators){
          const r = cmp(x,y);
          if (r) return r;
        }
        return 0;
      });
      return a;
    }

    function buildDerived(json){
      const thr = getThreshold(json);
      const videos = normalizeVideos(json);

      const topByLikes = sortByMany(
        videos,
        (a,b)=> b.likes - a.likes,
        (a,b)=> b.views - a.views,
        (a,b)=> b.like_rate - a.like_rate
      ).slice(0, 10).map((v,i)=> ({...v, rank:i+1}));

      const cand = videos.filter(v=> v.views >= thr);
      const topByRateFiltered = sortByMany(
        (cand.length ? cand : videos),
        (a,b)=> b.like_rate - a.like_rate,
        (a,b)=> b.likes - a.likes,
        (a,b)=> b.views - a.views
      ).slice(0, 10).map((v,i)=> ({...v, rank:i+1}));

      const topByRateUnfiltered = sortByMany(
        videos,
        (a,b)=> b.like_rate - a.like_rate,
        (a,b)=> b.likes - a.likes,
        (a,b)=> b.views - a.views
      ).slice(0, 10).map((v,i)=> ({...v, rank:i+1}));

      // Creators aggregation
      const byCreator = new Map();
      for (const v of videos){
        if (!v.username) continue;
        if (!byCreator.has(v.username)){
          byCreator.set(v.username, {
            username: v.username,
            videos_total_en_dataset: 0,
            sum_views: 0,
            sum_likes: 0,
            avg_like_rate: 0,
            avg_like_rate_pct: 0,
            top_count_likes: 0,
            top_video_urls_likes: []
          });
        }
        const c = byCreator.get(v.username);
        c.videos_total_en_dataset += 1;
        c.sum_views += v.views;
        c.sum_likes += v.likes;
      }

      // top_count_likes basado en topByLikes
      const topUrlsByCreator = new Map();
      for (const v of topByLikes){
        topUrlsByCreator.set(v.username, (topUrlsByCreator.get(v.username) || []).concat([v.url]));
      }
      for (const [u, urls] of topUrlsByCreator.entries()){
        const c = byCreator.get(u);
        if (!c) continue;
        c.top_count_likes = urls.length;
        c.top_video_urls_likes = urls.slice(0, 5);
      }

      for (const c of byCreator.values()){
        // promedio de like_rate por video (no ponderado)
        const userVideos = videos.filter(v=> v.username === c.username);
        const avg = userVideos.length ? (userVideos.reduce((a,v)=> a+v.like_rate, 0) / userVideos.length) : 0;
        c.avg_like_rate = avg;
        c.avg_like_rate_pct = avg * 100;
      }

      const creators = sortByMany(
        Array.from(byCreator.values()),
        (a,b)=> b.top_count_likes - a.top_count_likes,
        (a,b)=> b.sum_likes - a.sum_likes,
        (a,b)=> b.avg_like_rate - a.avg_like_rate
      ).map((c,i)=> ({...c, rank:i+1}));

      // Outliers (simple y útil)
      const outViews = sortByMany(videos, (a,b)=> b.views - a.views).slice(0, 5).map((v,i)=> ({
        ...v,
        explicacion: "pico de views (top " + (i+1) + ")"
      }));
      const outRate = sortByMany(videos, (a,b)=> b.like_rate - a.like_rate).slice(0, 5).map((v,i)=> ({
        ...v,
        explicacion: "pico de like rate (top " + (i+1) + ")"
      }));

      // Resumen + insights + acciones (sin GPT)
      const totalViews = videos.reduce((a,v)=> a+v.views, 0);
      const totalLikes = videos.reduce((a,v)=> a+v.likes, 0);
      const avgRate = videos.length ? (videos.reduce((a,v)=> a+v.like_rate, 0) / videos.length) : 0;

      const bestLikes = topByLikes[0] || null;
      const bestRate = topByRateFiltered[0] || null;
      const topCreator = creators[0] || null;

      const resumen =
        videos.length
          ? `Dataset: ${videos.length} videos · ${fmtK(totalViews)} views · ${fmtK(totalLikes)} likes · avg rate ${fmtPct(avgRate*100)}. Top likes: @${bestLikes?.username || "—"} (${fmtK(bestLikes?.likes || 0)}). Top rate (umbral ${thr}): @${bestRate?.username || "—"} (${fmtPct(bestRate?.like_rate_pct || 0)}). Dominio creator: @${topCreator?.username || "—"} (top_count ${safeNum(topCreator?.top_count_likes || 0)}).`
          : "Sin datos para renderizar.";

      const insights = [];
      if (bestLikes) insights.push(`top likes: @${bestLikes.username} · ${fmtK(bestLikes.likes)} likes · ${fmtK(bestLikes.views)} views`);
      if (bestRate) insights.push(`top eficiencia: @${bestRate.username} · rate ${fmtPct(bestRate.like_rate_pct)} con ${fmtK(bestRate.views)} views`);
      if (topCreator) insights.push(`creador dominante: @${topCreator.username} · top_count ${topCreator.top_count_likes} · likes ${fmtK(topCreator.sum_likes)}`);
      if (thr > 0) insights.push(`umbral like rate aplicado: ${thr} views (evita micro-virales falsos)`);

      const acciones = [];
      if (bestLikes) acciones.push({prioridad:"alta", accion:"clonar el patrón del top por likes", por_que:`replicar estructura/tema de @${bestLikes.username} (el video con más likes suele marcar la narrativa del día).`});
      if (bestRate) acciones.push({prioridad:"alta", accion:"extraer hooks del top por like rate", por_que:`rate ${fmtPct(bestRate.like_rate_pct)} sugiere hook fuerte; úsalo para 3 variaciones.`});
      if (topCreator) acciones.push({prioridad:"media", accion:"mapear creator dominante a ángulos reutilizables", por_que:`@${topCreator.username} domina por volumen/consistencia; arma lista de 5 ideas espejo.`});
      acciones.push({prioridad:"media", accion:"revisar outliers", por_que:"los picos de views y rate suelen indicar formatos explotables o ruido (micro-muestras)."});
      acciones.push({prioridad:"baja", accion:"limpiar dataset si hay duplicados", por_que:"si el top se repite con la misma URL, tu input está duplicando items y sesga rankings."});

      // notas (solo si hay señales)
      const notas = [];
      if (!Array.isArray(json.data?.videos)) notas.push("data.videos no es array; revisa el parseo del JSON.");
      if (videos.length === 0) notas.push("dataset vacío; revisa el módulo que alimenta el HTML.");
      if (thr === 0) notas.push("umbral 0; define umbral_views_like_rate o MIN_VIEWS_FOR_RATE para filtrar like_rate.");

      // reconstruye meta
      const meta = json.meta || {};
      const fecha = safeStr(meta.fecha_procesamiento) || safeStr(meta.fecha_reporte) || "";
      const fuente = safeStr(meta.fuente) || "";
      const total_items = safeNum(meta.total_items) || safeNum(meta.total_items_dedup) || videos.length;

      return {
        meta: {
          fecha_procesamiento: fecha,
          fuente,
          total_items,
          notas_parseo: (Array.isArray(meta.notas_parseo) ? meta.notas_parseo : []).concat(notas)
        },
        parametros: {
          umbral_views_like_rate: thr,
          definicion_score_interaccion: "score_interaccion = likes"
        },
        data: {
          videos,
          top_videos_by_likes: topByLikes,
          top_videos_by_like_rate: topByRateFiltered,
          top_videos_by_like_rate_unfiltered: topByRateUnfiltered,
          creators
        },
        outliers: {
          por_views: outViews,
          por_like_rate: outRate
        },
        resumen,
        insights,
        acciones_recomendadas: acciones
      };
    }

    // =========================
    // Rendering
    // =========================
    const state = {
      json: buildDerived(parseIncoming(window.__TREND_DATA__)),
      tab: "topLikes",
      q: "",
      creator: "",
      sortBy: "likes_desc"
    };

    function computeKPIs(json){
      const videos = (json.data && Array.isArray(json.data.videos)) ? json.data.videos : [];
      const totalViews = videos.reduce((a,v)=> a + safeNum(v.views), 0);
      const totalLikes = videos.reduce((a,v)=> a + safeNum(v.likes), 0);
      const avgRate = videos.length ? (videos.reduce((a,v)=> a + safeNum(v.like_rate), 0) / videos.length) : 0;

      const bestLikes = (json.data?.top_videos_by_likes && json.data.top_videos_by_likes[0]) || {};
      const bestRate = (json.data?.top_videos_by_like_rate && json.data.top_videos_by_like_rate[0]) || {};
      const topCreator = (json.data?.creators && json.data.creators[0]) || {};

      return {
        totalVideos: videos.length,
        totalViews,
        totalLikes,
        avgRate,
        bestLikes,
        bestRate,
        topCreator
      };
    }

    function setMeta(json){
      document.getElementById("metaDate").textContent = safeStr(json.meta?.fecha_procesamiento) || "—";
      document.getElementById("metaCount").textContent = String(safeNum(json.meta?.total_items) || (json.data?.videos?.length || 0));
      document.getElementById("thresholdPill").textContent = "umbral: " + String(getThreshold(json));
      document.getElementById("sourcePill").textContent = "fuente: " + (safeStr(json.meta?.fuente) || "—");
    }

    function renderKPIs(json){
      const k = computeKPIs(json);
      const kpis = [
        { label: "Total videos", value: k.totalVideos, hint: "dataset" , tone:"sky"},
        { label: "Views totales", value: fmtK(k.totalViews), hint: "suma" , tone:"purple"},
        { label: "Likes totales", value: fmtK(k.totalLikes), hint: "suma" , tone:"pink"},
        { label: "Avg like rate", value: fmtPct(k.avgRate*100), hint: "promedio" , tone:"lime"},
      ];

      const root = document.getElementById("kpis");
      root.innerHTML = "";
      kpis.forEach((x)=>{
        const node = el("div", {class:"kpi"}, [
          el("div", {class:"label"}, [x.label]),
          el("div", {class:"value"}, [String(x.value)]),
          el("div", {class:"hint"}, [x.hint])
        ]);
        node.style.borderColor =
          x.tone === "sky" ? "rgba(57,214,255,0.22)" :
          x.tone === "purple" ? "rgba(168,85,247,0.22)" :
          x.tone === "pink" ? "rgba(255,62,165,0.22)" :
          "rgba(158,255,122,0.22)";
        root.appendChild(node);
      });

      const subtitle = document.getElementById("subtitle");
      const topCreator = safeStr(k.topCreator.username);
      if (topCreator){
        subtitle.textContent = "Dominio del día: @" + topCreator + " · top_count: " + String(safeNum(k.topCreator.top_count_likes));
      } else {
        subtitle.textContent = "Panel de rendimiento y rankings diarios";
      }
    }

    function videoCard(rank, v, badgeTone){
      const url = safeStr(v.url);
      const username = safeStr(v.username);
      const vid = safeStr(v.video_id);
      const views = safeNum(v.views);
      const likes = safeNum(v.likes);
      const lr = safeNum(v.like_rate);
      const lrp = safeNum(v.like_rate_pct);

      const title = "@" + username + " · " + vid;
      return el("div", {class:"item"}, [
        el("div", {class:"badge " + badgeTone}, [String(rank)]),
        el("div", {class:"itemMain"}, [
          el("div", {class:"itemTop"}, [
            el("div", {class:"itemTitle"}, [
              el("a", {href: url || "#", target:"_blank", rel:"noopener noreferrer"}, [title])
            ]),
            el("div", {class:"pill mono"}, ["rate: " + fmtPct(lrp)])
          ]),
          el("div", {class:"itemMeta"}, [
            el("span", {class:"metaTag"}, [el("span",{class:"dot sky"}), "views ", fmtK(views)]),
            el("span", {class:"metaTag"}, [el("span",{class:"dot pink"}), "likes ", fmtK(likes)]),
            el("span", {class:"metaTag"}, [el("span",{class:"dot purple"}), "lr ", (Math.round(lr*1e6)/1e6).toFixed(6).replace(/0+$/,"").replace(/\.$/,"")])
          ]),
          safeStr(v.explicacion) ? el("div", {class:"cardSub", style:"margin-top:8px;"}, [safeStr(v.explicacion)]) : null
        ])
      ]);
    }

    function renderTopLists(json){
      const topLikes = (json.data?.top_videos_by_likes && Array.isArray(json.data.top_videos_by_likes)) ? json.data.top_videos_by_likes : [];
      const topRate = (json.data?.top_videos_by_like_rate && Array.isArray(json.data.top_videos_by_like_rate)) ? json.data.top_videos_by_like_rate : [];

      const likesRoot = document.getElementById("topLikesList");
      likesRoot.innerHTML = "";
      topLikes.forEach((v, i)=>{
        likesRoot.appendChild(videoCard(safeNum(v.rank) || (i+1), v, colorBadge(i)));
      });
      document.getElementById("topLikesHint").textContent = "top: " + String(topLikes.length || 0);

      const rateRoot = document.getElementById("topRateList");
      rateRoot.innerHTML = "";
      topRate.forEach((v, i)=>{
        rateRoot.appendChild(videoCard(safeNum(v.rank) || (i+1), v, colorBadge(i)));
      });
      document.getElementById("topRateHint").textContent = "candidatos: " + String(topRate.length || 0);
    }

    function renderCreators(json){
      const creators = (json.data?.creators && Array.isArray(json.data.creators)) ? json.data.creators : [];
      const tbody = document.getElementById("creatorsTbody");
      tbody.innerHTML = "";

      creators.forEach((c, idx)=>{
        const tr = document.createElement("tr");
        const rank = safeNum(c.rank) || (idx+1);
        const username = safeStr(c.username);
        const topCount = safeNum(c.top_count_likes);
        const likes = safeNum(c.sum_likes);
        const views = safeNum(c.sum_views);
        const avgRatePct = safeNum(c.avg_like_rate_pct);

        tr.innerHTML = `
          <td class="mono nowrap">${rank}</td>
          <td class="mono">@${username}</td>
          <td class="right mono">${topCount}</td>
          <td class="right mono">${fmtK(likes)}</td>
          <td class="right mono">${fmtK(views)}</td>
          <td class="right mono">${fmtPct(avgRatePct)}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("creatorCountPill").textContent = "creadores: " + String(creators.length || 0);

      // populate filter
      const videos = (json.data?.videos && Array.isArray(json.data.videos)) ? json.data.videos : [];
      const options = uniq(videos.map(v=> safeStr(v.username)).filter(Boolean)).sort((a,b)=> a.localeCompare(b));
      const select = document.getElementById("creatorFilter");
      const current = select.value;
      select.innerHTML = `<option value="">Todos los creadores</option>` + options.map(u=> `<option value="${u}">@${u}</option>`).join("");
      select.value = current;
    }

    function applyFilters(videos){
      let out = videos.slice();

      const q = state.q.trim().toLowerCase();
      if (q){
        out = out.filter(v=>{
          const u = safeStr(v.username).toLowerCase();
          const id = safeStr(v.video_id).toLowerCase();
          return u.includes(q) || id.includes(q);
        });
      }

      if (state.creator){
        out = out.filter(v=> safeStr(v.username) === state.creator);
      }

      const s = state.sortBy;
      const sorters = {
        likes_desc: (a,b)=> b.likes-a.likes || b.views-a.views,
        views_desc: (a,b)=> b.views-a.views || b.likes-a.likes,
        like_rate_desc: (a,b)=> b.like_rate-a.like_rate || b.likes-a.likes,
        rank_input_asc: (a,b)=> a.rank_input-b.rank_input
      };
      out.sort(sorters[s] || sorters.likes_desc);
      return out;
    }

    function renderVideosTable(json){
      const videos = (json.data?.videos && Array.isArray(json.data.videos)) ? json.data.videos : [];
      const filtered = applyFilters(videos);

      const tbody = document.getElementById("videosTbody");
      tbody.innerHTML = "";

      filtered.forEach((v, idx)=>{
        const tr = document.createElement("tr");
        const url = safeStr(v.url);
        const username = safeStr(v.username);
        const vid = safeStr(v.video_id);

        tr.innerHTML = `
          <td class="mono nowrap">${idx+1}</td>
          <td>
            <div style="display:flex; flex-direction:column; gap:4px;">
              <a href="${url || "#"}" target="_blank" rel="noopener noreferrer" style="font-weight:700; color:rgba(255,255,255,0.92); text-decoration:none;">
                @${username} · ${vid}
              </a>
              <div class="muted mono" style="font-size:11px; opacity:0.85;">${url ? url : ""}</div>
            </div>
          </td>
          <td class="right mono nowrap">${fmtK(safeNum(v.views))}</td>
          <td class="right mono nowrap">${fmtK(safeNum(v.likes))}</td>
          <td class="right mono nowrap">${fmtPct(safeNum(v.like_rate_pct))}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("allCountPill").textContent = "mostrando: " + filtered.length + " / " + videos.length;
    }

    function renderOutliers(json){
      const ov = (json.outliers?.por_views && Array.isArray(json.outliers.por_views)) ? json.outliers.por_views : [];
      const or = (json.outliers?.por_like_rate && Array.isArray(json.outliers.por_like_rate)) ? json.outliers.por_like_rate : [];

      const outViews = document.getElementById("outViews");
      const outRate = document.getElementById("outRate");
      outViews.innerHTML = "";
      outRate.innerHTML = "";

      ov.forEach((x,i)=>{
        outViews.appendChild(videoCard(i+1, x, colorBadge(i)));
      });

      or.forEach((x,i)=>{
        outRate.appendChild(videoCard(i+1, x, colorBadge(i)));
      });

      document.getElementById("outlierPill").textContent = "views: " + ov.length + " · rate: " + or.length;
    }

    function renderNotes(json){
      const notes = (json.meta?.notas_parseo && Array.isArray(json.meta.notas_parseo)) ? json.meta.notas_parseo : [];
      const root = document.getElementById("notesList");
      root.innerHTML = "";
      if (!notes.length){
        root.appendChild(el("div",{class:"notice"},["—"]));
        return;
      }
      notes.forEach((t,i)=>{
        root.appendChild(el("div",{class:"item"},[
          el("div",{class:"badge "+colorBadge(i)},["!"]),
          el("div",{class:"itemMain"},[
            el("div",{class:"cardSub", style:"margin:0; color:rgba(255,255,255,0.78);"},[safeStr(t)])
          ])
        ]));
      });
    }

    function renderSummary(json){
      document.getElementById("resumenBox").textContent = safeStr(json.resumen) || "—";

      const insights = (json.insights && Array.isArray(json.insights)) ? json.insights : [];
      const box = document.getElementById("insightsBox");
      box.innerHTML = "";
      if (!insights.length){
        box.appendChild(el("div",{class:"muted"},["—"]));
      } else {
        insights.forEach((t,i)=>{
          box.appendChild(el("div",{class:"metaTag"},[
            el("span",{class:"dot "+colorBadge(i)}),
            safeStr(t)
          ]));
        });
      }

      const acts = (json.acciones_recomendadas && Array.isArray(json.acciones_recomendadas)) ? json.acciones_recomendadas : [];
      document.getElementById("actionsPill").textContent = "items: " + String(acts.length || 0);

      const list = document.getElementById("actionsList");
      list.innerHTML = "";
      if (!acts.length){
        list.appendChild(el("div",{class:"notice"},["—"]));
      } else {
        acts.forEach((a,i)=>{
          const pri = safeStr(a.prioridad) || "media";
          const priDot = pri === "alta" ? "pink" : (pri === "baja" ? "lime" : "purple");
          list.appendChild(el("div",{class:"item"},[
            el("div",{class:"badge "+priDot},[(i+1).toString()]),
            el("div",{class:"itemMain"},[
              el("div",{class:"itemTop"},[
                el("div",{class:"itemTitle"},[safeStr(a.accion) || "Acción"]),
                el("div",{class:"pill mono"},["prioridad: " + pri])
              ]),
              el("div",{class:"cardSub", style:"margin-top:8px;"},[safeStr(a.por_que) || ""])
            ])
          ]));
        });
      }
    }

    function switchTab(tab){
      state.tab = tab;
      const map = {
        topLikes: "tab_topLikes",
        topRate: "tab_topRate",
        allVideos: "tab_allVideos",
        creators: "tab_creators",
        outliers: "tab_outliers"
      };

      Object.values(map).forEach(id=>{
        const elx = document.getElementById(id);
        if (elx) elx.style.display = "none";
      });
      const activeId = map[tab];
      const active = document.getElementById(activeId);
      if (active) active.style.display = "";

      document.querySelectorAll("#viewTabs button").forEach(b=>{
        b.classList.toggle("active", b.dataset.tab === tab);
      });
    }

    function renderAll(){
      const json = state.json;

      setMeta(json);
      renderKPIs(json);
      renderTopLists(json);
      renderCreators(json);
      renderVideosTable(json);
      renderOutliers(json);
      renderNotes(json);
      renderSummary(json);

      switchTab(state.tab);
    }

    // =========================
    // Events
    // =========================
    document.getElementById("q").addEventListener("input", (e)=>{
      state.q = e.target.value || "";
      renderVideosTable(state.json);
    });

    document.getElementById("creatorFilter").addEventListener("change", (e)=>{
      state.creator = e.target.value || "";
      renderVideosTable(state.json);
    });

    document.getElementById("sortBy").addEventListener("change", (e)=>{
      state.sortBy = e.target.value || "likes_desc";
      renderVideosTable(state.json);
    });

    document.getElementById("viewTabs").addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if (!btn) return;
      switchTab(btn.dataset.tab);
    });

    document.getElementById("reloadBtn").addEventListener("click", ()=>{
      const parsed = parseIncoming(window.__TREND_DATA__);
      state.json = buildDerived(parsed);
      renderAll();
    });

    // First render
    renderAll();
  </script>
</body>
</html>
